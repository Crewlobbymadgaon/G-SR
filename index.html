<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>G&SR — Konkan Railway (Offline Book)</title>
  <meta name="description" content="G&SR of Konkan Railway — Offline web book. Cover-first UX with TOC." />
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b63d6">

  <style>
    :root{
      --bg:#f6f9ff; --card:#ffffff; --kr:#0b63d6; --kr-2:#0b9cff;
      --muted:#6b7280; --radius:14px; --glass: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:#071033;background:var(--bg);-webkit-font-smoothing:antialiased}
    a{color:inherit}

    /* header */
    header{
      position:fixed;left:0;right:0;top:0;height:64px;padding:10px 14px;display:flex;align-items:center;gap:12px;
      background:linear-gradient(90deg,var(--kr),var(--kr-2));color:#fff;z-index:1200;
      box-shadow:0 4px 18px rgba(11,99,214,0.14);
    }
    .brand{font-weight:800;font-size:1.05rem;flex:1;text-align:center;letter-spacing:.2px}

    /* stylish menu button (animated hamburger -> X) */
    .menu-btn{
      --size:44px;
      width:var(--size);height:var(--size);display:inline-grid;place-items:center;border-radius:10px;
      background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);cursor:pointer;padding:8px;
      transition:transform .18s ease, background .18s ease;
    }
    .menu-btn:active{transform:scale(.98)}
    .hamburger{
      width:22px;height:16px;position:relative;display:inline-block;
    }
    .hamburger span{
      position:absolute;left:0;right:0;height:2px;background:#fff;border-radius:2px;display:block;
      transition:transform .24s cubic-bezier(.2,.9,.2,1),opacity .18s ease,top .24s cubic-bezier(.2,.9,.2,1);
    }
    .hamburger span:nth-child(1){top:0}
    .hamburger span:nth-child(2){top:7px}
    .hamburger span:nth-child(3){top:14px}
    .menu-btn.open .hamburger span:nth-child(1){transform:translateY(7px) rotate(45deg)}
    .menu-btn.open .hamburger span:nth-child(2){opacity:0}
    .menu-btn.open .hamburger span:nth-child(3){transform:translateY(-7px) rotate(-45deg)}

    /* layout */
    main{padding:88px 16px 120px;max-width:980px;margin:0 auto}
    .cover{
      background:linear-gradient(180deg,#fff,#eef6ff);
      border-radius:16px;padding:28px;box-shadow:0 8px 30px rgba(11,63,120,0.06);
      display:flex;flex-direction:column;gap:12px;align-items:center;text-align:center;
    }
    .cover h1{margin:0;font-size:1.6rem;color:#05204a}
    .cover p{margin:0;color:var(--muted)}
    .open-btn{
      margin-top:8px;padding:10px 16px;border-radius:12px;border:0;background:linear-gradient(90deg,var(--kr),var(--kr-2));
      color:#fff;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(11,99,214,0.18)
    }
    .meta-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:.95rem}

    /* TOC drawer */
    #tocDrawer{
      position:fixed;left:12px;top:84px;bottom:100px;width:320px;max-width:86vw;background:var(--card);
      border-radius:12px;padding:12px 10px;box-shadow:0 18px 40px rgba(7,16,40,0.12);transform:translateY(-8px);
      opacity:0;pointer-events:none;transition:opacity .22s ease,transform .22s ease;z-index:1300;
    }
    #tocDrawer.open{opacity:1;pointer-events:auto;transform:translateY(0)}
    #tocDrawer h2{margin:6px 0 8px;font-size:1rem}
    .toc-list{list-style:none;padding:0;margin:0;max-height:60vh;overflow:auto}
    .toc-list li{padding:8px;border-radius:10px;margin:4px 0}
    .toc-list a{display:block;text-decoration:none;color:#05204a;font-weight:600;padding:4px 6px}
    .toc-list a:focus{outline:3px solid rgba(11,99,214,0.12);border-radius:8px}

    /* reader viewport */
    #reader{margin-top:18px}
    .chapter{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(7,16,40,0.04)}
    .chapter h2{margin-top:0}
    #resultsArea{display:none;margin-top:10px}

    footer{position:fixed;left:0;right:0;bottom:0;padding:12px;background:rgba(255,255,255,0.9);backdrop-filter:blur(4px);
      display:flex;align-items:center;justify-content:center;gap:12px;box-shadow:0 -6px 18px rgba(7,16,40,0.03)}
    .nav-small{background:#fff;border-radius:10px;padding:6px 8px;border:1px solid rgba(7,16,40,0.04)}
    .nav-small button{border:0;background:transparent;cursor:pointer;font-weight:700}

    /* responsive */
    @media (max-width:880px){
      .brand{font-size:.98rem}
      #tocDrawer{left:6px;right:6px;width:auto;top:76px;bottom:110px}
      main{padding:84px 12px 140px}
    }
  </style>
</head>
<body>
  <header>
    <button id="btnMenu" class="menu-btn" aria-label="Open table of contents" aria-expanded="false">
      <span class="hamburger" aria-hidden="true"><span></span><span></span><span></span></span>
    </button>

    <div class="brand" aria-live="polite">G&SR — Konkan Railway</div>

    <!-- right side small placeholder (can add search / install) -->
    <div style="width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.06)"></div>
  </header>

  <!-- TOC drawer -->
  <nav id="tocDrawer" aria-hidden="true" aria-label="Table of contents">
    <h2>Contents</h2>
    <ul id="tocList" class="toc-list" role="list"></ul>
    <div style="margin-top:8px;color:var(--muted);font-size:.92rem">Tap an item to open. Chapters are loaded on demand and cached for offline use.</div>
  </nav>

  <main>
    <!-- Cover (first view) -->
    <section id="cover" class="cover" role="main" aria-labelledby="coverTitle">
      <h1 id="coverTitle">G&SR — Konkan Railway</h1>
      <p class="meta-row">Official Guide & Special Rules — Offline Web Edition</p>
      <p style="max-width:70ch;margin-top:10px;color:var(--muted)">This lightweight shell opens instantly to the cover. Tap "Open Book" or use the menu to jump to chapters. Chapters are fetched lazily and cached by the service worker.</p>
      <div style="display:flex;gap:10px;align-items:center">
        <button id="openBook" class="open-btn" aria-label="Open book">Open Book</button>
        <button id="prefetchBtn" class="open-btn" style="background:#fff;color:var(--kr);font-weight:700;border:1px solid rgba(11,99,214,0.08)">Prefetch First</button>
      </div>
    </section>

    <!-- search/ results (hidden by default) -->
    <div id="resultsArea" role="region" aria-live="polite"></div>

    <!-- Reader viewport: chapters are injected here -->
    <section id="reader" aria-live="polite">
      <!-- placeholder when no chapter loaded -->
      <div class="chapter" id="placeholder">
        <h2>Welcome</h2>
        <p style="color:var(--muted)">Open a chapter from the menu, or press "Open Book" to start from Chapter 1. While offline, previously opened chapters remain available thanks to the service worker.</p>
      </div>
    </section>
  </main>

  <footer>
    <div class="nav-small"><button id="prevBtn" aria-label="Previous">◀</button></div>
    <div style="color:var(--muted);font-size:.95rem">© Konkan Railway — G&SR</div>
    <div class="nav-small"><button id="nextBtn" aria-label="Next">▶</button></div>
  </footer>

  <script>
    /* ---- Basic app: populate TOC, handle cover-first UX, lazy-load chapters, register SW ---- */

    // small list of chapters; adjust titles / count or generate dynamically
    const CHAPTERS = [
      { id: 'ch1', title: 'Chapter 1 — Introduction' },
      { id: 'ch2', title: 'Chapter 2 — Definitions & Interpretations' },
      { id: 'ch3', title: 'Chapter 3 — Personnel & Duties' },
      { id: 'ch4', title: 'Chapter 4 — Signalling' },
      { id: 'ch5', title: 'Chapter 5 — Block Working' },
      { id: 'ch6', title: 'Chapter 6 — Train Operations' },
      { id: 'ch7', title: 'Chapter 7 — Speed Restrictions' },
      { id: 'ch8', title: 'Chapter 8 — Signalling Failures' },
      { id: 'ch9', title: 'Chapter 9 — Block Instruments & Communication' },
      { id: 'ch10', title: 'Chapter 10 — Shunting & Yard Working' },
      { id: 'ch11', title: 'Chapter 11 — Working Rules for Trains' },
      { id: 'ch12', title: 'Chapter 12 — Safety & Emergency Procedures' },
      { id: 'ch13', title: 'Chapter 13 — Working of Level Crossings' },
      { id: 'ch14', title: 'Chapter 14 — Tunnels & Special Sections' },
      { id: 'ch15', title: 'Chapter 15 — Electrical & Signalling Maintenance' },
      { id: 'ch16', title: 'Chapter 16 — Training & Competency' },
      { id: 'ch17', title: 'Chapter 17 — Record Keeping & Reporting' },
      { id: 'ch18', title: 'Chapter 18 — Annexures & Forms' },
      { id: 'appendix', title: 'Appendix — Reference Material' }
    ];

    // refs
    const tocList = document.getElementById('tocList');
    const btnMenu = document.getElementById('btnMenu');
    const tocDrawer = document.getElementById('tocDrawer');
    const openBook = document.getElementById('openBook');
    const prefetchBtn = document.getElementById('prefetchBtn');
    const reader = document.getElementById('reader');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const placeholder = document.getElementById('placeholder');
    const menuBtnInner = btnMenu;

    // state
    let currentIndex = -1; // -1 = cover
    let cache = {}; // track loaded chapters in-memory (also cached by service worker)

    // populate TOC
    CHAPTERS.forEach((c, i) => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = '#' + c.id;
      a.textContent = `${i+1}. ${c.title}`;
      a.dataset.index = i;
      a.addEventListener('click', (e) => {
        e.preventDefault();
        openChapterByIndex(i);
        closeTOC();
      });
      li.appendChild(a);
      tocList.appendChild(li);
    });

    // menu toggle (animated)
    btnMenu.addEventListener('click', ()=>{
      const open = tocDrawer.classList.toggle('open');
      btnMenu.classList.toggle('open', open);
      btnMenu.setAttribute('aria-expanded', String(open));
      tocDrawer.setAttribute('aria-hidden', String(!open));
      if(open) { // focus first link
        setTimeout(()=>{ const first = tocDrawer.querySelector('a'); if(first) first.focus(); }, 80);
      } else {
        btnMenu.focus();
      }
    });

    function closeTOC(){
      tocDrawer.classList.remove('open');
      btnMenu.classList.remove('open');
      btnMenu.setAttribute('aria-expanded','false');
      tocDrawer.setAttribute('aria-hidden','true');
    }

    // open book (first chapter)
    openBook.addEventListener('click', ()=>{ openChapterByIndex(0); });

    // prefetch first chapter (useful to warm cache)
    prefetchBtn.addEventListener('click', ()=>{
      prefetchChapter(0).then(()=> alert('First chapter prefetched (cached).')).catch(()=> alert('Prefetch failed (maybe offline).'));
    });

    // navigation Prev / Next
    prevBtn.addEventListener('click', ()=>{
      if(currentIndex > 0) openChapterByIndex(currentIndex - 1);
      else if(currentIndex === 0) goCover();
    });
    nextBtn.addEventListener('click', ()=>{
      if(currentIndex < CHAPTERS.length - 1) openChapterByIndex(currentIndex + 1);
    });

    function goCover(){
      currentIndex = -1;
      placeholder.scrollIntoView({behavior: 'smooth', block: 'start'});
      // ensure cover visible: we assume the cover section is in the DOM above reader
      document.getElementById('cover').focus?.();
      updateFooter();
    }

    function updateFooter(){
      prevBtn.disabled = (currentIndex === -1);
      nextBtn.disabled = (currentIndex === -1 || currentIndex >= CHAPTERS.length - 1);
      prevBtn.style.opacity = prevBtn.disabled ? '.45' : '1';
      nextBtn.style.opacity = nextBtn.disabled ? '.45' : '1';
    }

    // load chapter by index
    async function openChapterByIndex(i){
      if(i < 0 || i >= CHAPTERS.length) return;
      currentIndex = i;
      const chap = CHAPTERS[i];
      await loadChapter(chap.id);
      updateFooter();
      // update history hash
      history.pushState({id:chap.id, index:i}, '', '#' + chap.id);
    }

    // load chapter HTML fragment from /chapters/{id}.html
    async function loadChapter(id){
      // if already loaded in-memory, show immediately
      if(cache[id]){
        renderChapter(cache[id], id);
        return;
      }
      try{
        showLoader();
        const url = `/chapters/${id}.html`;
        const res = await fetch(url, {cache:'force-cache'});
        if(!res.ok) throw new Error('Fetch failed');
        const text = await res.text();
        cache[id] = text;
        renderChapter(text, id);
      }catch(e){
        showError('Unable to load chapter. You may be offline and this chapter is not cached yet.');
      }finally{
        hideLoader();
      }
    }

    function renderChapter(html, id){
      // sanitize/assume trusted content (these are your files)
      reader.innerHTML = '';
      const wrapper = document.createElement('div');
      wrapper.className = 'chapter';
      // if the chapter fragment already contains a top-level element like <article>, prefer it
      // but for simplicity we inject the returned HTML
      wrapper.innerHTML = html || `<h2>${id}</h2><p>No content.</p>`;
      reader.appendChild(wrapper);
      // focus the new content for accessibility
      wrapper.setAttribute('tabindex','-1');
      wrapper.focus();
    }

    function showLoader(){
      // small inline loader: add 'Loading...' under reader if absent
      if(!document.getElementById('loader')){
        const d = document.createElement('div');
        d.id = 'loader'; d.style.marginTop = '12px'; d.style.color = 'var(--muted)';
        d.textContent = 'Loading chapter…';
        reader.appendChild(d);
      }
    }
    function hideLoader(){ const l = document.getElementById('loader'); if(l) l.remove(); }

    function showError(msg){
      reader.innerHTML = `<div class="chapter"><h2>Error</h2><p style="color:var(--muted)">${msg}</p></div>`;
    }

    // prefetch (useful when user is idle)
    async function prefetchChapter(i){
      if(i < 0 || i >= CHAPTERS.length) return;
      const id = CHAPTERS[i].id;
      if(cache[id]) return Promise.resolve();
      const url = `/chapters/${id}.html`;
      const res = await fetch(url, {cache:'force-cache'});
      if(!res.ok) throw new Error('prefetch failed');
      const text = await res.text();
      cache[id] = text;
    }

    // try idle prefetch for first chapter
    if('requestIdleCallback' in window){
      requestIdleCallback(()=> prefetchChapter(0).catch(()=>{}));
    } else {
      setTimeout(()=> prefetchChapter(0).catch(()=>{}), 3500);
    }

    // service worker registration
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/sw.js').then(reg=>{
        console.log('SW registered', reg);
      }).catch(err=>{
        console.warn('SW failed', err);
      });
    }

    // handle back/forward
    window.addEventListener('popstate', (ev)=>{
      const state = ev.state;
      if(!state){
        goCover(); return;
      }
      if(state.id){
        const idx = state.index ?? CHAPTERS.findIndex(c=>c.id===state.id);
        if(typeof idx === 'number' && idx >=0) openChapterByIndex(idx);
      }
    });

    // keyboard: Esc closes toc
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        closeTOC();
      }
    });

    // clicking outside drawer closes it (for small screens)
    document.addEventListener('click', (e)=>{
      if(!tocDrawer.classList.contains('open')) return;
      if(e.target.closest('#tocDrawer') || e.target.closest('#btnMenu')) return;
      closeTOC();
    });

    // init: show cover
    goCover();
    updateFooter();

    // expose a small keyboard shortcut: Ctrl/Cmd+M to toggle menu
    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase() === 'm'){ e.preventDefault(); btnMenu.click(); }
    });
  </script>
</body>
</html>
