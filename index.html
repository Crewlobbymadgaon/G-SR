<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>G&SR</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0b63d6">
<link rel="apple-touch-icon" sizes="192x192" href="assets/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="assets/icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
:root{
  --bg:#f6f9ff; --card:#fff; --kr:#0b63d6; --kr2:#0b9cff; --muted:#6b7280;
  --header-h:64px; --footer-h:60px; --desktop-break:980px; --page-gap:24px; --page-max-width:1200px;
  --update-interval-ms:900000;
  --highlight-color: #fff59d;
  --base-font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, Helvetica, "Times New Roman", serif;
  --base-font-size: 16px;
  --rule-num-width: 84px;
  --gutter:12px;
}

*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:var(--base-font-family);background:var(--bg);color:#071033;font-size:var(--base-font-size);}
header{
  position:fixed;left:0;right:0;top:0;height:var(--header-h);
  display:flex;align-items:center;padding:10px 14px;background:linear-gradient(90deg,var(--kr),var(--kr2));color:#fff;z-index:1200;
}
.header-left{width:44px;height:44px;display:flex;align-items:center;justify-content:flex-start}
.header-center{flex:1;display:flex;align-items:center;justify-content:center}
.header-right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
.brand{font-weight:800; font-size:1rem; text-align:center;}
.icon-btn{width:40px;height:40px;display:grid;place-items:center;border-radius:8px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);cursor:pointer;color:#fff}
.icon{width:18px;height:18px;display:block}
.main-actions{display:flex;gap:8px;align-items:center}

/* disabled look */
.icon-btn[disabled]{ opacity:0.5; pointer-events:none; }

main{padding:calc(var(--header-h) + 12px) 16px calc(var(--footer-h) + 16px);max-width:var(--page-max-width);margin:0 auto;min-height:320px}

#cover { width:100%; border-radius:16px; overflow:hidden; height:520px; position:relative; background:#111; box-shadow:0 12px 30px rgba(0,0,0,.14); display:flex; align-items:center; justify-content:center; }
#cover img{ max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; object-position:center center; display:block; background:#111; }

#reader { margin-top:18px; display:none; }
.mobile-chapter { background:var(--card); padding:18px; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.05); }

@media(min-width:980px){
  #cover{ height: calc(100vh - var(--header-h) - var(--footer-h) - var(--page-gap)); border-radius:0; box-shadow:none; background:linear-gradient(180deg,#0f1724 0%, #061229 100%); }
  #cover img{ max-width: min(var(--page-max-width), 92vw); max-height: calc(100vh - var(--header-h) - var(--footer-h) - var(--page-gap)); }
  .page-shell{ display:flex; justify-content:center; align-items:center; width:100%; box-sizing:border-box; margin-top:18px; }
  .book-page{ width: min(var(--page-max-width), 92vw); height: calc(100vh - var(--header-h) - var(--footer-h) - var(--page-gap)); background:var(--card); border-radius:8px; overflow:hidden; box-shadow:0 12px 40px rgba(6,18,41,0.08); display:flex; flex-direction:column; margin:0 auto; }
  .page-frame{ padding:20px; overflow:auto; flex:1 1 auto; }
  .page-frame .chapter { padding:0; background:transparent; box-shadow:none; border-radius:0; }
}

/* SEARCH PANEL */
#searchPanel{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  top:var(--header-h);
  z-index:1400;
  width: min(1000px, 94vw);
  background: #fff;
  border-radius:10px;
  box-shadow:0 18px 40px rgba(4,10,26,0.24);
  display:flex;
  gap:8px;
  padding:10px;
  align-items:center;
  max-height:calc(100vh - var(--header-h) - 16px);
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  display:none;
  touch-action: manipulation;
}
#searchPanel .panel-row{ display:flex; gap:8px; align-items:center; width:100%; }
#searchPanel .left-col{ display:flex; gap:8px; align-items:center; flex:1; }
#searchPanel .right-col{ display:flex; gap:8px; align-items:center; justify-content:flex-end; }

@media(max-width:640px){
  #searchPanel{ left:8px; transform:none; width: calc(100% - 16px); top: var(--header-h); padding:10px; flex-direction:column; align-items:stretch; max-height: calc(100vh - var(--header-h) - 16px); }
  #searchPanel .panel-row{ flex-direction:column; align-items:stretch; gap:10px; }
  #searchResults{ width:100%; border-left:none; padding-left:0; margin-top:8px; }
}

#searchInput{ flex:1; padding:10px 12px; border-radius:8px; border:1px solid #e2e8f0; font-size:16px; width:100%; }
#searchResults{ max-height:50vh; overflow:auto; width:360px; border-left:1px solid #eef2ff; padding-left:12px; }
.search-item{ padding:8px; border-radius:8px; cursor:pointer; border:1px solid transparent; margin-bottom:6px; }
.search-item:hover{ background:#f7fbff; border-color:#e6f0ff; }
.search-snippet{ color:#475569; font-size:0.95rem; margin-top:6px; }

/* highlight */
.search-highlight { background: var(--highlight-color); padding:0 2px; border-radius:2px; box-shadow:0 0 0 4px rgba(255,245,157,0.12) inset; animation: highlight-pulse 1400ms ease; }
@keyframes highlight-pulse { 0%{ box-shadow:0 0 0 6px rgba(255,245,157,0.18) inset; } 100%{ box-shadow:0 0 0 0 rgba(255,245,157,0.0) inset; } }

.chapter-content{ text-align:justify; text-justify:inter-word; hyphens:auto; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; font-size:var(--base-font-size); line-height:1.6; font-family:var(--base-font-family); color:#1b2b3a; }
.chapter-content p{ margin:0 0 14px; }

#tocDrawer{position:fixed;left:12px;top:84px;bottom:100px;width:340px;max-width:92vw;background:var(--card);border-radius:14px;padding:12px;box-shadow:0 18px 40px rgba(0,0,0,.12);opacity:0;pointer-events:none;transform:translateY(-10px);transition:.24s;z-index:1300}
#tocDrawer.open{opacity:1;pointer-events:auto;transform:none}
.toc-title{font-weight:800;margin:4px 0 12px;font-size:1.05rem;color:#05204a}
.toc-list .toc-item{ font-weight:700; color:#05204a; padding:6px 8px; cursor:pointer; }
.toc-list .toc-sub{ font-weight:800; color:#05204a; padding:6px 8px 6px 20px; cursor:pointer; }

.hidden{display:none !important}
.small-muted{color:#6b7280;font-size:0.95rem}
.doc-chapter { max-width: 920px; margin: 0 auto; padding: 20px 14px; color: #0b1726; line-height: 1.55; font-family: var(--base-font-family); }

.page-frame .rule,
.mobile-chapter .rule {
  display:flex;
  gap:var(--gutter);
  align-items:flex-start;
  margin:8px 0 14px;
  width:100%;
}
.page-frame .rule .num,
.mobile-chapter .rule .num {
  width:var(--rule-num-width);
  min-width:64px;
  font-weight:800;
  color:#061229;
  padding-top:2px;
  flex:0 0 var(--rule-num-width);
}
.page-frame .rule .content,
.mobile-chapter .rule .content {
  flex:1 1 auto;
}
.page-frame .rule .heading,
.mobile-chapter .rule .heading {
  font-weight:800;
  text-align:left;
  margin:0 0 8px 0;
  font-size:1.02rem;
  display:block;
  scroll-margin-top: calc(var(--header-h) + 8px);
}


/* ensure any element with id (target) receives offset scroll to avoid header overlap */
.chapter [id], .mobile-chapter [id], .page-frame .chapter [id] { scroll-margin-top: calc(var(--header-h) + 8px); }

@media(max-width:640px){
  :root{ --rule-num-width:68px; --base-font-size:17px; }
  .page-frame{ padding:14px; }
  .mobile-chapter{ padding:16px; border-radius:10px; }
  .page-frame .rule .heading, .mobile-chapter .rule .heading{ font-size:1rem; }
}
.page-frame .rule .heading { line-height:1.25; }

footer{position:fixed;left:0;right:0;bottom:0;padding:12px;background:#fff;display:flex;justify-content:center;gap:12px;box-shadow:0 -6px 18px rgba(0,0,0,.05);z-index:1200}
.nav-small button{background:#fff;border:1px solid #ccc;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}

/* Strong safety: hide any nav controls added incorrectly inside header area */
header .prev, header .next, header .header-nav, header .nav-small, header .header-forward, header .header-back {
  display: none !important;
}
</style>
</head>
<body>
  <header>
    <div class="header-left">
      <button id="btnMenu" class="icon-btn" aria-label="Open TOC">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>

    <div class="header-center"><div class="brand">G&SR — Konkan Railway</div></div>

    <div class="header-right">
      <!-- header back/forward removed on purpose (footer has navigation) -->

      <button id="btnSearch" class="icon-btn" title="Search the book (global)">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="6"></circle><path d="M21 21l-4.35-4.35"></path>
        </svg>
      </button>
    </div>
  </header>

  <div id="searchPanel" role="search" aria-hidden="true">
    <div class="panel-row">
      <div class="left-col">
        <input id="searchInput" placeholder="Search the entire book — type to search (live)"/>
        <button id="searchClear" class="icon-btn" title="Clear search" aria-label="Clear search">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
      <div class="right-col">
        <button id="searchClose" class="icon-btn" title="Close search" aria-label="Close search">✕</button>
      </div>
    </div>

    <div id="searchResults" aria-live="polite"></div>
  </div>

  <nav id="tocDrawer" aria-hidden="true" aria-label="Arrangement of Rules">
    <div class="toc-title">ARRANGEMENT OF RULES</div>
    <ul id="tocList" class="toc-list" role="list" style="list-style:none;padding:0;margin:0;max-height:60vh;overflow:auto"></ul>
  </nav>

  <main>
    <section id="cover" aria-hidden="false" role="img" aria-label="Book cover image">
      <img id="coverImg" srcset="assets/cover-800.webp 800w, assets/cover-1200.webp 1200w, assets/cover-1600.webp 1600w"
           sizes="(max-width:640px) 95vw, (max-width:980px) 90vw, 1200px"
           src="assets/cover-1600.webp" alt="G&SR Konkan Railway — Book cover" decoding="async" loading="eager" />
    </section>

    <section id="reader" aria-live="polite" tabindex="-1" style="display:none;">
      <div class="page-shell" id="pageShell" style="display:none;">
        <div class="book-page" id="bookPage" role="region" aria-label="Book page">
          <div class="page-frame" id="pageFrame">
  <iframe id="chapterFrame"
          style="width:100%; height:100%; border:none; background:#fff;"
          loading="lazy"
          title="Chapter content"></iframe>
</div>

        </div>
      </div>

     <div id="mobileReader" style="display:none;">
  <iframe id="mobileChapterFrame"
          style="width:100%; min-height:100vh; border:none; background:#fff;"
          loading="lazy"
          title="Chapter content"></iframe>
</div>

    </section>
  </main>

  <footer>
    <div class="nav-small"><button id="prevBtn" aria-label="Previous">◀</button></div>
    <div class="nav-small"><button id="nextBtn" aria-label="Next">▶</button></div>
  </footer>

<script>
const DESKTOP_BREAK = 980;
const VISITED_FLAG = 'gkr_had_started_reading';
const LAST_READ_KEY = 'gkr_last_read';
const SCROLL_PREFIX = 'gkr_scroll_';

const tocList = document.getElementById('tocList');
const btnMenu = document.getElementById('btnMenu');
const tocDrawer = document.getElementById('tocDrawer');
const cover = document.getElementById('cover');
const reader = document.getElementById('reader');
const pageShell = document.getElementById('pageShell');
const pageFrame = document.getElementById('pageFrame');
const mobileReader = document.getElementById('mobileReader');

const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

let currentFlatIndex = -1;

/* ---------------- helpers ---------------- */

function isDesktop(){ return window.innerWidth >= DESKTOP_BREAK; }

function getActiveFrame(){
  return isDesktop()
    ? document.getElementById('chapterFrame')
    : document.getElementById('mobileChapterFrame');
}

function markStarted(){
  try{ localStorage.setItem(VISITED_FLAG,'1'); }catch(e){}
}

function saveLastRead(obj){
  try{ localStorage.setItem(LAST_READ_KEY, JSON.stringify(obj)); }catch(e){}
}

function loadLastRead(){
  try{
    const r = localStorage.getItem(LAST_READ_KEY);
    return r ? JSON.parse(r) : null;
  }catch(e){ return null; }
}

/* ---------------- TOC ---------------- */

btnMenu.addEventListener('click', ()=>{
  tocDrawer.classList.toggle('open');
});

document.addEventListener('click', e=>{
  if(!tocDrawer.classList.contains('open')) return;
  if(e.target.closest('#tocDrawer') || e.target.closest('#btnMenu')) return;
  tocDrawer.classList.remove('open');
});

/* ---------------- OPEN CHAPTER / FRAGMENT ---------------- */

async function openFragment(id){
  const iframe = getActiveFrame();

  cover.style.display = 'none';
  reader.style.display = 'block';
  pageShell.style.display = isDesktop() ? 'flex' : 'none';
  mobileReader.style.display = isDesktop() ? 'none' : 'block';

  iframe.src = `chapters/${id}.html`;

  saveLastRead({ kind:'fragment', id });
}

async function openChapter(id, anchor=null){
  const iframe = getActiveFrame();

  cover.style.display = 'none';
  reader.style.display = 'block';
  pageShell.style.display = isDesktop() ? 'flex' : 'none';
  mobileReader.style.display = isDesktop() ? 'none' : 'block';

  iframe.src = anchor
    ? `chapters/${id}.html#${anchor}`
    : `chapters/${id}.html`;

  saveLastRead({ kind:'chapter', id, anchor });
}

/* ---------------- RESTORE ON LOAD ---------------- */

window.addEventListener('load', async ()=>{
  const started = localStorage.getItem(VISITED_FLAG);
  const last = loadLastRead();

  if(!started){
    showCover();
    return;
  }

  if(last){
    if(last.kind === 'fragment') await openFragment(last.id);
    if(last.kind === 'chapter') await openChapter(last.id, last.anchor || null);
    return;
  }

  showCover();
});

function showCover(){
  cover.style.display = 'flex';
  reader.style.display = 'none';
  pageShell.style.display = 'none';
  mobileReader.style.display = 'none';
}

const SEARCH_Q_KEY = 'gkr_search_q';

const btnSearch = document.getElementById('btnSearch');
const searchPanel = document.getElementById('searchPanel');
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
const searchClose = document.getElementById('searchClose');
const searchClear = document.getElementById('searchClear');

/* ---------------- SEARCH UI ---------------- */

btnSearch.onclick = ()=> {
  searchPanel.style.display = 'flex';
  searchInput.focus();
};

searchClose.onclick = closeSearch;
searchClear.onclick = clearSearch;

function closeSearch(){
  searchPanel.style.display = 'none';
}

function clearSearch(){
  searchInput.value = '';
  searchResults.innerHTML = '<div class="small-muted">Type to search</div>';
}

/* ---------------- SEARCH RESULT CLICK → HIGHLIGHT ---------------- */

function highlightInIframe(iframe, query){
  if(!query) return;

  try{
    const doc = iframe.contentDocument;
    if(!doc) return;

    const esc = query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    const re = new RegExp(esc, 'gi');

    const walker = doc.createTreeWalker(
      doc.body,
      NodeFilter.SHOW_TEXT,
      {
        acceptNode(n){
          if(!n.nodeValue || !n.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
          const p = n.parentElement;
          if(!p) return NodeFilter.FILTER_REJECT;
          if(['SCRIPT','STYLE','NOSCRIPT'].includes(p.tagName)) return NodeFilter.FILTER_REJECT;
          return NodeFilter.FILTER_ACCEPT;
        }
      }
    );

    const nodes = [];
    let x;
    while(x = walker.nextNode()) nodes.push(x);

    nodes.forEach(n=>{
      if(!re.test(n.nodeValue)) return;
      re.lastIndex = 0;

      const frag = doc.createDocumentFragment();
      let last = 0, m;

      while((m = re.exec(n.nodeValue))){
        if(m.index > last){
          frag.appendChild(doc.createTextNode(n.nodeValue.slice(last, m.index)));
        }
        const mark = doc.createElement('mark');
        mark.style.background = '#fff59d';
        mark.textContent = m[0];
        frag.appendChild(mark);
        last = m.index + m[0].length;
      }

      frag.appendChild(doc.createTextNode(n.nodeValue.slice(last)));
      n.parentNode.replaceChild(frag, n);
    });

    const first = doc.querySelector('mark');
    if(first){
      first.scrollIntoView({ behavior:'smooth', block:'center' });
    }
  }catch(e){}
}

/* ---------------- SEARCH RESULT CLICK HANDLER ---------------- */

function onSearchResultClick(id, query){
  openChapter(id, null).then(()=>{
    const iframe = getActiveFrame();
    iframe.onload = ()=> highlightInIframe(iframe, query);
  });
  closeSearch();
}
</script>


</body>
</html>
