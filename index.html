<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>G&SR</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0b63d6">
<link rel="apple-touch-icon" sizes="192x192" href="assets/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="assets/icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
:root{
  --bg:#f6f9ff; --card:#fff; --kr:#0b63d6; --kr2:#0b9cff; --muted:#6b7280;
  --header-h:64px; --footer-h:60px; --desktop-break:980px; --page-gap:24px; --page-max-width:1200px;
  --update-interval-ms:900000;
  --highlight-color: #fff59d;
  --base-font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, Helvetica, "Times New Roman", serif;
  --base-font-size: 16px;
  --rule-num-width: 84px;
  --gutter:12px;
}

*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:var(--base-font-family);background:var(--bg);color:#071033;font-size:var(--base-font-size);}
header{
  position:fixed;left:0;right:0;top:0;height:var(--header-h);
  display:flex;align-items:center;padding:10px 14px;background:linear-gradient(90deg,var(--kr),var(--kr2));color:#fff;z-index:1200;
}
.header-left{width:44px;height:44px;display:flex;align-items:center;justify-content:flex-start}
.header-center{flex:1;display:flex;align-items:center;justify-content:center}
.header-right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
.brand{font-weight:800; font-size:1rem; text-align:center;}
.icon-btn{width:40px;height:40px;display:grid;place-items:center;border-radius:8px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);cursor:pointer;color:#fff}
.icon{width:18px;height:18px;display:block}
.main-actions{display:flex;gap:8px;align-items:center}

/* disabled look */
.icon-btn[disabled]{ opacity:0.5; pointer-events:none; }

main{padding:calc(var(--header-h) + 12px) 16px calc(var(--footer-h) + 16px);max-width:var(--page-max-width);margin:0 auto;min-height:320px}

#cover { width:100%; border-radius:16px; overflow:hidden; height:520px; position:relative; background:#111; box-shadow:0 12px 30px rgba(0,0,0,.14); display:flex; align-items:center; justify-content:center; }
#cover img{ max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; object-position:center center; display:block; background:#111; }

#reader { margin-top:18px; display:none; }
.mobile-chapter { background:var(--card); padding:18px; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.05); }

@media(min-width:980px){
  #cover{ height: calc(100vh - var(--header-h) - var(--footer-h) - var(--page-gap)); border-radius:0; box-shadow:none; background:linear-gradient(180deg,#0f1724 0%, #061229 100%); }
  #cover img{ max-width: min(var(--page-max-width), 92vw); max-height: calc(100vh - var(--header-h) - var(--footer-h) - var(--page-gap)); }
  .page-shell{ display:flex; justify-content:center; align-items:center; width:100%; box-sizing:border-box; margin-top:18px; }
  .book-page{ width: min(var(--page-max-width), 92vw); height: calc(100vh - var(--header-h) - var(--footer-h) - var(--page-gap)); background:var(--card); border-radius:8px; overflow:hidden; box-shadow:0 12px 40px rgba(6,18,41,0.08); display:flex; flex-direction:column; margin:0 auto; }
  .page-frame{ padding:20px; overflow:auto; flex:1 1 auto; }
  .page-frame .chapter { padding:0; background:transparent; box-shadow:none; border-radius:0; }
}

/* SEARCH PANEL */
#searchPanel{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  top:var(--header-h);
  z-index:1400;
  width: min(1000px, 94vw);
  background: #fff;
  border-radius:10px;
  box-shadow:0 18px 40px rgba(4,10,26,0.24);
  display:flex;
  gap:8px;
  padding:10px;
  align-items:center;
  max-height:calc(100vh - var(--header-h) - 16px);
  overflow:auto;
  -webkit-overflow-scrolling: touch;
  display:none;
  touch-action: manipulation;
}
#searchPanel .panel-row{ display:flex; gap:8px; align-items:center; width:100%; }
#searchPanel .left-col{ display:flex; gap:8px; align-items:center; flex:1; }
#searchPanel .right-col{ display:flex; gap:8px; align-items:center; justify-content:flex-end; }

@media(max-width:640px){
  #searchPanel{ left:8px; transform:none; width: calc(100% - 16px); top: var(--header-h); padding:10px; flex-direction:column; align-items:stretch; max-height: calc(100vh - var(--header-h) - 16px); }
  #searchPanel .panel-row{ flex-direction:column; align-items:stretch; gap:10px; }
  #searchResults{ width:100%; border-left:none; padding-left:0; margin-top:8px; }
}

#searchInput{ flex:1; padding:10px 12px; border-radius:8px; border:1px solid #e2e8f0; font-size:16px; width:100%; }
#searchResults{ max-height:50vh; overflow:auto; width:360px; border-left:1px solid #eef2ff; padding-left:12px; }
.search-item{ padding:8px; border-radius:8px; cursor:pointer; border:1px solid transparent; margin-bottom:6px; }
.search-item:hover{ background:#f7fbff; border-color:#e6f0ff; }
.search-snippet{ color:#475569; font-size:0.95rem; margin-top:6px; }

/* highlight */
.search-highlight { background: var(--highlight-color); padding:0 2px; border-radius:2px; box-shadow:0 0 0 4px rgba(255,245,157,0.12) inset; animation: highlight-pulse 1400ms ease; }
@keyframes highlight-pulse { 0%{ box-shadow:0 0 0 6px rgba(255,245,157,0.18) inset; } 100%{ box-shadow:0 0 0 0 rgba(255,245,157,0.0) inset; } }

.chapter-content{ text-align:justify; text-justify:inter-word; hyphens:auto; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; font-size:var(--base-font-size); line-height:1.6; font-family:var(--base-font-family); color:#1b2b3a; }
.chapter-content p{ margin:0 0 14px; }

#tocDrawer{position:fixed;left:12px;top:84px;bottom:100px;width:340px;max-width:92vw;background:var(--card);border-radius:14px;padding:12px;box-shadow:0 18px 40px rgba(0,0,0,.12);opacity:0;pointer-events:none;transform:translateY(-10px);transition:.24s;z-index:1300}
#tocDrawer.open{opacity:1;pointer-events:auto;transform:none}
.toc-title{font-weight:800;margin:4px 0 12px;font-size:1.05rem;color:#05204a}
.toc-list .toc-item{ font-weight:700; color:#05204a; padding:6px 8px; cursor:pointer; }
.toc-list .toc-sub{ font-weight:800; color:#05204a; padding:6px 8px 6px 20px; cursor:pointer; }

.hidden{display:none !important}
.small-muted{color:#6b7280;font-size:0.95rem}
.doc-chapter { max-width: 920px; margin: 0 auto; padding: 20px 14px; color: #0b1726; line-height: 1.55; font-family: var(--base-font-family); }

.page-frame .rule,
.mobile-chapter .rule {
  display:flex;
  gap:var(--gutter);
  align-items:flex-start;
  margin:8px 0 14px;
  width:100%;
}
.page-frame .rule .num,
.mobile-chapter .rule .num {
  width:var(--rule-num-width);
  min-width:64px;
  font-weight:800;
  color:#061229;
  padding-top:2px;
  flex:0 0 var(--rule-num-width);
}
.page-frame .rule .content,
.mobile-chapter .rule .content {
  flex:1 1 auto;
}
.page-frame .rule .heading,
.mobile-chapter .rule .heading {
  font-weight:800;
  text-align:left;
  margin:0 0 8px 0;
  font-size:1.02rem;
  display:block;
  scroll-margin-top: calc(var(--header-h) + 8px);
}


/* ensure any element with id (target) receives offset scroll to avoid header overlap */
.chapter [id], .mobile-chapter [id], .page-frame .chapter [id] { scroll-margin-top: calc(var(--header-h) + 8px); }

@media(max-width:640px){
  :root{ --rule-num-width:68px; --base-font-size:17px; }
  .page-frame{ padding:14px; }
  .mobile-chapter{ padding:16px; border-radius:10px; }
  .page-frame .rule .heading, .mobile-chapter .rule .heading{ font-size:1rem; }
}
.page-frame .rule .heading { line-height:1.25; }

footer{position:fixed;left:0;right:0;bottom:0;padding:12px;background:#fff;display:flex;justify-content:center;gap:12px;box-shadow:0 -6px 18px rgba(0,0,0,.05);z-index:1200}
.nav-small button{background:#fff;border:1px solid #ccc;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}

/* Strong safety: hide any nav controls added incorrectly inside header area */
header .prev, header .next, header .header-nav, header .nav-small, header .header-forward, header .header-back {
  display: none !important;
}
</style>
</head>
<body>
  <header>
    <div class="header-left">
      <button id="btnMenu" class="icon-btn" aria-label="Open TOC">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>

    <div class="header-center"><div class="brand">G&SR — Konkan Railway</div></div>

    <div class="header-right">
      <!-- header back/forward removed on purpose (footer has navigation) -->

      <button id="btnSearch" class="icon-btn" title="Search the book (global)">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="6"></circle><path d="M21 21l-4.35-4.35"></path>
        </svg>
      </button>
    </div>
  </header>

  <div id="searchPanel" role="search" aria-hidden="true">
    <div class="panel-row">
      <div class="left-col">
        <input id="searchInput" placeholder="Search the entire book — type to search (live)"/>
        <button id="searchClear" class="icon-btn" title="Clear search" aria-label="Clear search">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
      <div class="right-col">
        <button id="searchClose" class="icon-btn" title="Close search" aria-label="Close search">✕</button>
      </div>
    </div>

    <div id="searchResults" aria-live="polite"></div>
  </div>

  <nav id="tocDrawer" aria-hidden="true" aria-label="Arrangement of Rules">
    <div class="toc-title">ARRANGEMENT OF RULES</div>
    <ul id="tocList" class="toc-list" role="list" style="list-style:none;padding:0;margin:0;max-height:60vh;overflow:auto"></ul>
  </nav>

  <main>
    <section id="cover" aria-hidden="false" role="img" aria-label="Book cover image">
      <img id="coverImg" srcset="assets/cover-800.webp 800w, assets/cover-1200.webp 1200w, assets/cover-1600.webp 1600w"
           sizes="(max-width:640px) 95vw, (max-width:980px) 90vw, 1200px"
           src="assets/cover-1600.webp" alt="G&SR Konkan Railway — Book cover" decoding="async" loading="eager" />
    </section>

    <section id="reader" aria-live="polite" tabindex="-1" style="display:none;">
      <div class="page-shell" id="pageShell" style="display:none;">
        <div class="book-page" id="bookPage" role="region" aria-label="Book page">
          <div class="page-frame" id="pageFrame">
  <iframe id="chapterFrame"
          style="width:100%; height:100%; border:none; background:#fff;"
          loading="lazy"
          title="Chapter content"></iframe>
</div>

        </div>
      </div>

     <div id="mobileReader" style="display:none;">
  <iframe id="mobileChapterFrame"
          style="width:100%; min-height:100vh; border:none; background:#fff;"
          loading="lazy"
          title="Chapter content"></iframe>
</div>

    </section>
  </main>

  <footer>
    <div class="nav-small"><button id="prevBtn" aria-label="Previous">◀</button></div>
    <div class="nav-small"><button id="nextBtn" aria-label="Next">▶</button></div>
  </footer>

<script>
const DESKTOP_BREAK = 980;
const VISITED_FLAG = 'gkr_had_started_reading';
const LAST_READ_KEY = 'gkr_last_read';
const SCROLL_PREFIX = 'gkr_scroll_';
const UPDATE_TS_KEY = 'gkr_last_update_ts';
const UPDATE_INTERVAL_MS = 900000;
const SEARCH_Q_KEY = 'gkr_search_q';
const SEARCH_R_KEY = 'gkr_search_r';

const TOC = [
  { type: 'fragment', id: 'notification', label: 'Notification' },
  { type: 'fragment', id: 'resolution', label: 'Resolution' },
  { type: 'fragment', id: 'documents_accompanying', label: 'Documents Accompanying' },
  { type: 'chapter', id: 'ch1', label: 'CHAPTER I — PRELIMINARY', children: [
      { anchor:'s101', label:'1.01 Short title and commencement' },
      { anchor:'s102', label:'1.02 Definitions' },
      { anchor:'s103', label:'1.03 Classification of Stations' }
    ]
  },
  { type:'chapter', id:'ch2', label:'Chapter 2 — Definitions & Interpretations' },
  { type:'chapter', id:'ch3', label:'Chapter 3 — Personnel & Duties' },
  { type:'chapter', id:'ch4', label:'Chapter 4 — Signalling' },
  { type:'chapter', id:'ch5', label:'Chapter 5 — Block Working' },
  { type:'chapter', id:'ch6', label:'Chapter 6 — Train Operations' },
  { type:'chapter', id:'ch7', label:'Chapter 7 — Speed Restrictions' },
  { type:'chapter', id:'ch8', label:'Chapter 8 — Signalling Failures' },
  { type:'chapter', id:'ch9', label:'Chapter 9 — Block Instruments & Communication' },
  { type:'chapter', id:'ch10', label:'Chapter 10 — Shunting & Yard Working' },
  { type:'chapter', id:'ch11', label:'Chapter 11 — Working Rules for Trains' },
  { type:'chapter', id:'ch12', label:'Chapter 12 — Safety & Emergency Procedures' },
  { type:'chapter', id:'ch13', label:'Chapter 13 — Working of Level Crossings' },
  { type:'chapter', id:'ch14', label:'Chapter 14 — Tunnels & Special Sections' },
  { type:'chapter', id:'ch15', label:'Chapter 15 — Electrical & Signalling Maintenance' },
  { type:'chapter', id:'ch16', label:'Chapter 16 — Training & Competency' },
  { type:'chapter', id:'ch17', label:'Chapter 17 — Record Keeping & Reporting' },
  { type:'chapter', id:'ch18', label:'Chapter 18 — Annexures & Forms' },
  { type:'chapter', id:'appendix', label:'Appendix — Reference Material' }
];

const FLAT = [];
TOC.forEach(item=>{
  if(item.type === 'fragment') FLAT.push({ kind:'fragment', id:item.id });
  else if(item.type === 'chapter'){
    FLAT.push({ kind:'chapter', id:item.id });
    if(item.children) item.children.forEach(sub => FLAT.push({ kind:'anchor', chapter:item.id, anchor:sub.anchor }));
  }
});

const tocList = document.getElementById('tocList');
const btnMenu = document.getElementById('btnMenu');
const tocDrawer = document.getElementById('tocDrawer');
const cover = document.getElementById('cover');
const reader = document.getElementById('reader');
const pageShell = document.getElementById('pageShell');
const pageFrame = document.getElementById('pageFrame');
const pageChapter = document.getElementById('pageChapter');
const mobileReader = document.getElementById('mobileReader');
const mobileChapter = document.getElementById('mobileChapter');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

const btnSearch = document.getElementById('btnSearch');
const searchPanel = document.getElementById('searchPanel');
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
const searchClose = document.getElementById('searchClose');
const searchClear = document.getElementById('searchClear');

let cache = {};
let currentFlatIndex = -1;
let lastHtml = null;
let bgTimer = null;
let lastQuery = localStorage.getItem(SEARCH_Q_KEY) || '';
let lastResults = [];

function buildTOC(){
  tocList.innerHTML = '';
  TOC.forEach(item=>{
    const li = document.createElement('li');
    const btn = document.createElement('div');
    btn.className = 'toc-item';
    btn.textContent = item.label;
    btn.style.padding = '6px 8px';
    btn.style.cursor = 'pointer';
    btn.onclick = ()=> openFromTOC(item);
    li.appendChild(btn);
    tocList.appendChild(li);
    if(item.children){
      item.children.forEach(ch=>{
        const sli = document.createElement('li');
        const sbtn = document.createElement('div');
        sbtn.className = 'toc-sub';
        sbtn.textContent = ch.label;
        sbtn.style.padding = '6px 8px 6px 20px';
        sbtn.style.cursor = 'pointer';
        sbtn.onclick = ()=> openAnchor(item.id, ch.anchor);
        sli.appendChild(sbtn);
        tocList.appendChild(sli);
      });
    }
  });
}
buildTOC();

/* TOC toggle */
btnMenu.addEventListener('click', ()=>{
  const open = tocDrawer.classList.toggle('open');
  btnMenu.classList.toggle('open', open);
  btnMenu.setAttribute('aria-expanded', String(open));
  tocDrawer.setAttribute('aria-hidden', String(!open));
});
document.addEventListener('click', (e)=>{
  if(!tocDrawer.classList.contains('open')) return;
  if(e.target.closest('#tocDrawer') || e.target.closest('#btnMenu')) return;
  tocDrawer.classList.remove('open');
  btnMenu.classList.remove('open');
});

/* Close TOC when item clicked (delegated) */
(function installTOCCloseHandler(){
  const toc = tocList;
  if(!toc) return;
  toc.addEventListener('click', function(e){
    const target = e.target.closest('.toc-item, .toc-sub, a, button');
    if(!target) return;
    if(tocDrawer && btnMenu){
      tocDrawer.classList.remove('open');
      btnMenu.classList.remove('open');
      tocDrawer.setAttribute('aria-hidden', 'true');
      btnMenu.setAttribute('aria-expanded', 'false');
    }
  }, { passive: true });
})();

async function fetchChapterRaw(id, bypass=false){
  try{
    const url = bypass ? `chapters/${id}.html?_=${Date.now()}` : `chapters/${id}.html`;
    const res = await fetch(url, bypass ? { cache:'no-store' } : { cache:'force-cache' });
    if(res.ok) return await res.text();
  }catch(e){ /* ignore */ }
  return null;
}
async function getHtml(id){
  if(cache[id]) return cache[id];
  const t = await fetchChapterRaw(id, false);
  if(t){ cache[id] = t; return t; }
  return `<article class="chapter-content"><h2 style="margin-top:0">${id}</h2><p style="color:var(--muted)">Missing file: chapters/${id}.html — upload this file to show content.</p></article>`;
}

async function openFromTOC(item){
  tocDrawer.classList.remove('open'); btnMenu.classList.remove('open');
  markStarted();
  if(item.type === 'fragment') await openFragment(item.id);
  else await openChapter(item.id, null);
}
async function openAnchor(chapterId, anchorId){ markStarted(); await openChapter(chapterId, anchorId); }
  function getActiveFrame(){
  return isDesktop()
    ? document.getElementById('chapterFrame')
    : document.getElementById('mobileChapterFrame');
}

async function openFragment(id){
  const iframe = getActiveFrame();

  cover.style.display = 'none';
  reader.style.display = 'block';
  pageShell.style.display = isDesktop() ? 'flex' : 'none';
  mobileReader.style.display = isDesktop() ? 'none' : 'block';

  iframe.src = `chapters/${id}.html`;

  currentFlatIndex = FLAT.findIndex(f => f.kind === 'fragment' && f.id === id);
  saveLastRead({ kind:'fragment', id });
  updateNavButtons();
}

async function openChapter(chId, anchor = null){
  const iframe = getActiveFrame();

  cover.style.display = 'none';
  reader.style.display = 'block';
  pageShell.style.display = isDesktop() ? 'flex' : 'none';
  mobileReader.style.display = isDesktop() ? 'none' : 'block';

  // build URL with anchor (native browser scrolling)
  const url = anchor
    ? `chapters/${chId}.html#${anchor}`
    : `chapters/${chId}.html`;

  iframe.src = url;

  if(anchor){
    currentFlatIndex = FLAT.findIndex(
      f => f.kind === 'anchor' && f.chapter === chId && f.anchor === anchor
    );
    saveLastRead({ kind:'chapter', id:chId, anchor });
  } else {
    currentFlatIndex = FLAT.findIndex(
      f => f.kind === 'chapter' && f.id === chId
    );
    saveLastRead({ kind:'chapter', id:chId, anchor:null });
  }

  updateNavButtons();
}


function renderHtml(html, highlight=null){
  cover.style.display = 'none';
  reader.style.display = 'block';

  const isDesk = isDesktop();
  pageShell.style.display = isDesk ? 'flex' : 'none';
  mobileReader.style.display = isDesk ? 'none' : 'block';

  const iframe = isDesk
    ? document.getElementById('chapterFrame')
    : document.getElementById('mobileChapterFrame');

  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  iframe.src = url;

  // cleanup old blob
  iframe.onload = () => URL.revokeObjectURL(url);
}


function removeExistingHighlights(){
  const prevs = document.querySelectorAll('mark.search-highlight');
  prevs.forEach(m => {
    const txt = m.textContent;
    const parent = m.parentNode;
    if(!parent) return;
    parent.replaceChild(document.createTextNode(txt), m);
    parent.normalize();
  });
}
function highlightAllInContainer(container, rawQuery){
  if(!rawQuery) return 0;
  const q = String(rawQuery).trim();
  if(!q) return 0;
  const esc = q.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
  const re = new RegExp(esc, 'ig');

  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, {
    acceptNode(node){
      if(!node.nodeValue) return NodeFilter.FILTER_REJECT;
      const parent = node.parentElement;
      if(!parent) return NodeFilter.FILTER_REJECT;
      const tag = parent.tagName.toLowerCase();
      if(tag === 'script' || tag === 'style' || tag === 'noscript' || parent.closest('#searchResults')) return NodeFilter.FILTER_REJECT;
      if(node.nodeValue.trim().length === 0) return NodeFilter.FILTER_REJECT;
      return NodeFilter.FILTER_ACCEPT;
    }
  });

  let matches = 0;
  const nodesToProcess = [];
  let n;
  while(n = walker.nextNode()){
    nodesToProcess.push(n);
  }

  for(const textNode of nodesToProcess){
    const text = textNode.nodeValue;
    if(!text) continue;
    if(!re.test(text)) continue;
    re.lastIndex = 0;
    const frag = document.createDocumentFragment();
    let lastIndex = 0;
    let m;
    while((m = re.exec(text)) !== null){
      const idx = m.index;
      const matchText = m[0];
      if(idx > lastIndex){
        frag.appendChild(document.createTextNode(text.slice(lastIndex, idx)));
      }
      const mark = document.createElement('mark');
      mark.className = 'search-highlight';
      mark.textContent = matchText;
      frag.appendChild(mark);
      matches++;
      lastIndex = idx + matchText.length;
    }
    if(lastIndex < text.length){
      frag.appendChild(document.createTextNode(text.slice(lastIndex)));
    }
    const parent = textNode.parentNode;
    if(parent) parent.replaceChild(frag, textNode);
  }

  const first = container.querySelector('mark.search-highlight');
  if(first){
    try{ first.scrollIntoView({ behavior: 'smooth', block: 'center' }); }catch(e){}
    setTimeout(()=> { if(first) first.classList.remove('search-highlight'); }, 2200);
  }
  return matches;
}

/* navigation helpers */
nextBtn.addEventListener('click', gotoNext);
prevBtn.addEventListener('click', gotoPrev);

function gotoNext(){
  if(currentFlatIndex === -1){ if(FLAT.length > 0) openFlatItem(FLAT[0], 0); return; }
  if(currentFlatIndex < FLAT.length - 1) openFlatItem(FLAT[currentFlatIndex + 1], currentFlatIndex + 1);
}
function gotoPrev(){
  if(currentFlatIndex > 0) openFlatItem(FLAT[currentFlatIndex - 1], currentFlatIndex - 1);
  else showCover();
}
function openFlatItem(it, idx){ currentFlatIndex = idx; if(it.kind === 'fragment') openFragment(it.id); else if(it.kind === 'chapter') openChapter(it.id, null); else if(it.kind === 'anchor') openChapter(it.chapter, it.anchor); }

function updateNavButtons(){
  const hasPrev = currentFlatIndex > 0;
  const hasNext = currentFlatIndex >= 0 && currentFlatIndex < FLAT.length - 1;
  if(prevBtn) prevBtn.disabled = !hasPrev;
  if(nextBtn) nextBtn.disabled = !hasNext;
}

/* last-read helpers & scroll savers */
function saveLastRead(obj){ try{ localStorage.setItem(LAST_READ_KEY, JSON.stringify(Object.assign({}, obj, { ts: Date.now() }))); }catch(e){} }
function loadLastRead(){ try{ const raw = localStorage.getItem(LAST_READ_KEY); return raw ? JSON.parse(raw) : null; }catch(e){ return null; } }
function markStarted(){ try{ localStorage.setItem(VISITED_FLAG, '1'); }catch(e){} }

let pageSaver = { timer:null, lastSaved:0, id:null, handler:null };
function attachPageSaverIfNeeded(){ detachPageSaver(); const it = (currentFlatIndex>=0 && currentFlatIndex<FLAT.length)?FLAT[currentFlatIndex]:null; if(!it || it.kind!=='chapter') return; pageSaver.id = it.id; pageSaver.handler = ()=> { const now = Date.now(); if(now - pageSaver.lastSaved > 800) try{ localStorage.setItem(SCROLL_PREFIX + pageSaver.id, String(Math.floor(pageFrame.scrollTop || 0))); }catch(e){} clearTimeout(pageSaver.timer); pageSaver.timer = setTimeout(()=> { try{ localStorage.setItem(SCROLL_PREFIX + pageSaver.id, String(Math.floor(pageFrame.scrollTop || 0))); }catch(e){} }, 700); pageSaver.lastSaved = now; }; pageFrame.addEventListener('scroll', pageSaver.handler, { passive:true }); }
function detachPageSaver(){ try{ if(pageSaver.handler) pageFrame.removeEventListener('scroll', pageSaver.handler); if(pageSaver.timer) clearTimeout(pageSaver.timer); }catch(e){} pageSaver={ timer:null, lastSaved:0, id:null, handler:null }; }
function restorePageScrollIfAny(chId){ try{ const raw = localStorage.getItem(SCROLL_PREFIX + chId); const n = raw ? Number(raw)||0 : 0; setTimeout(()=> pageFrame.scrollTo({ top: n, behavior:'auto' }), 80); }catch(e){} }

let winSaver = { timer:null, lastSaved:0, id:null, handler:null };
function attachWindowSaverIfNeeded(){ detachWindowSaver(); const it = (currentFlatIndex>=0 && currentFlatIndex<FLAT.length)?FLAT[currentFlatIndex]:null; if(!it || it.kind!=='chapter') return; winSaver.id = it.id; winSaver.handler = ()=> { const now = Date.now(); if(now - winSaver.lastSaved > 800) try{ localStorage.setItem(SCROLL_PREFIX + winSaver.id, String(Math.floor(window.scrollY || 0))); }catch(e){} clearTimeout(winSaver.timer); winSaver.timer = setTimeout(()=> { try{ localStorage.setItem(SCROLL_PREFIX + winSaver.id, String(Math.floor(window.scrollY || 0))); }catch(e){} }, 700); winSaver.lastSaved = now; }; window.addEventListener('scroll', winSaver.handler, { passive:true }); }
function detachWindowSaver(){ try{ if(winSaver.handler) window.removeEventListener('scroll', winSaver.handler); if(winSaver.timer) clearTimeout(winSaver.timer); }catch(e){} winSaver={ timer:null, lastSaved:0, id:null, handler:null }; }
function restoreWindowScrollIfAny(chId){ try{ const raw = localStorage.getItem(SCROLL_PREFIX + chId); const n = raw ? Number(raw)||0 : 0; setTimeout(()=> window.scrollTo({ top: n, behavior:'auto' }), 80); }catch(e){} }

function collectChapterIds(){ const s = new Set(); TOC.forEach(it=>{ if(it.type==='fragment') s.add(it.id); else if(it.type==='chapter') s.add(it.id); }); return Array.from(s); }
async function updateAllBackground(){ const ids = collectChapterIds(); if(!ids.length) return; for(const id of ids){ try{ const t = await fetchChapterRaw(id, true); if(t) cache[id] = t; }catch(e){} } try{ localStorage.setItem(UPDATE_TS_KEY, String(Date.now())); }catch(e){} }
function startBackgroundUpdater(){ if(navigator.onLine) updateAllBackground().catch(()=>{}); if(bgTimer) clearInterval(bgTimer); bgTimer = setInterval(()=> { if(navigator.onLine) updateAllBackground().catch(()=>{}); }, UPDATE_INTERVAL_MS); window.addEventListener('online', ()=> { updateAllBackground().catch(()=>{}); }); }

/* SEARCH (clean snippets + safe rendering) */
function openSearchPanel(){ window.__gkr_search_open = true; searchPanel.style.display = 'flex'; searchPanel.setAttribute('aria-hidden','false'); const q = localStorage.getItem(SEARCH_Q_KEY) || lastQuery || ''; searchInput.value = q; if(q){ if(lastResults && lastResults.length) renderSearchResults(lastResults); debouncePerformSearch(q, 0); } else { searchResults.innerHTML = '<div class="small-muted">Type to search</div>'; } setTimeout(()=> { try{ searchInput.focus(); const val = searchInput.value; searchInput.setSelectionRange(val.length, val.length);}catch(e){} }, 420); searchPanel.addEventListener('touchstart', stopTouchBubble, { passive:true }); searchPanel.addEventListener('click', stopTouchBubble, { passive:true }); window.__gkr_search_resize_lock = true; setTimeout(()=> { window.__gkr_search_resize_lock = false; }, 900); }
function closeSearchPanel(){ window.__gkr_search_open = false; searchPanel.style.display = 'none'; searchPanel.setAttribute('aria-hidden','true'); searchPanel.removeEventListener('touchstart', stopTouchBubble); searchPanel.removeEventListener('click', stopTouchBubble); window.__gkr_search_resize_lock = false; }
function clearSearch(){ searchInput.value = ''; lastQuery = ''; lastResults = []; try{ localStorage.removeItem(SEARCH_Q_KEY); localStorage.removeItem(SEARCH_R_KEY); }catch(e){} searchResults.innerHTML = '<div class="small-muted">Type to search</div>'; removeExistingHighlights(); try{ const it = (currentFlatIndex >=0 && currentFlatIndex < FLAT.length) ? FLAT[currentFlatIndex] : null; if(it && it.kind === 'chapter'){ if(isDesktop()) restorePageScrollIfAny(it.id); else restoreWindowScrollIfAny(it.id); } }catch(e){} try{ searchInput.focus(); const v = searchInput.value || ''; searchInput.setSelectionRange(v.length, v.length);}catch(e){} }
function stopTouchBubble(e){ e.stopPropagation(); }
let _debT = null;
function debouncePerformSearch(q, delay=220){ clearTimeout(_debT); _debT = setTimeout(()=> performSearch(q), delay); }
function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function highlightSnippetEscaped(escapedSnippet, q){ if(!q) return escapedSnippet; const esc = String(q).replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'); const re = new RegExp(esc, 'ig'); return escapedSnippet.replace(re, match => `<mark class="search-highlight">${match}</mark>`); }

/* renderSearchResults (safe: snippet is plain text) */
function renderSearchResults(list){
  lastResults = list || [];
  try{ localStorage.setItem(SEARCH_R_KEY, JSON.stringify(lastResults)); }catch(e){}
  if(!list || list.length === 0){
    searchResults.innerHTML = '<div class="small-muted">No results</div>';
    return;
  }
  const q = (searchInput.value || lastQuery || '').trim();
  searchResults.innerHTML = '';

  list.forEach(r=>{
    const div = document.createElement('div');
    div.className = 'search-item';
    const escaped = escapeHtml(String(r.snippet || ''));
    const highlighted = q ? highlightSnippetEscaped(escaped, q) : escaped;
    div.innerHTML = `<div style="font-weight:700">${escapeHtml(r.id)}</div><div class="search-snippet">${highlighted}</div>`;
    div.onclick = async () => {
  const query = q || searchInput.value;

  await openFragmentOrChapter(r.id);

  const iframe = getActiveFrame();

  iframe.onload = () => {
    highlightInIframe(iframe, query);
  };

  closeSearchPanel();
};


    searchResults.appendChild(div);
  });
}

/* performSearch (parse HTML -> textContent to avoid returning raw HTML) */
async function performSearch(q){
  q = (q||'').trim();
  lastQuery = q;
  try{ localStorage.setItem(SEARCH_Q_KEY, q); }catch(e){}
  if(!q){ searchResults.innerHTML = '<div class="small-muted">Type to search</div>'; lastResults = []; try{ localStorage.removeItem(SEARCH_R_KEY); }catch(e){}; return; }
  searchResults.innerHTML = '<div class="small-muted">Searching…</div>';

  const needle = q.toLowerCase();
  const ids = collectChapterIds();
  const results = [];

  for(const id of ids){
    if(!cache[id]){
      const t = await fetchChapterRaw(id, false);
      if(t) cache[id] = t;
      else cache[id] = '';
    }
    const html = cache[id] || '';

    let text = '';
    try {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const scripts = doc.querySelectorAll('script, style, noscript');
      scripts.forEach(n => n.remove());
      const container = doc.querySelector('.chapter-content') || doc.body;
      text = container.textContent || '';
    } catch(e){
      text = html.replace(/<script[\s\S]*?<\/script>/gi,' ').replace(/<\/?[^>]+(>|$)/g, ' ');
    }
    text = text.replace(/\s+/g, ' ').trim();
    const lower = text.toLowerCase();
    const idx = lower.indexOf(needle);
    if(idx !== -1){
      const start = Math.max(0, idx - 80);
      const end = Math.min(text.length, idx + 180);
      let snippet = text.substring(start, end).trim();
      if(start > 0) snippet = '…' + snippet;
      if(end < text.length) snippet = snippet + '…';
      results.push({ id, snippet });
    }
  }

  renderSearchResults(results);
}

async function openFragmentOrChapter(id){
  const isChapter = TOC.some(it => it.type === 'chapter' && it.id === id);
  const isFragment = TOC.some(it => it.type === 'fragment' && it.id === id);

  if(isFragment){
    await openFragment(id);
  } else if(isChapter){
    await openChapter(id, null);
  } else {
    await openFragment(id);
  }
}
function highlightInIframe(iframe, query){
  if(!query) return;

  try{
    const doc = iframe.contentDocument;
    if(!doc) return;

    const esc = query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    const re = new RegExp(esc, 'gi');

    const walker = doc.createTreeWalker(
      doc.body,
      NodeFilter.SHOW_TEXT,
      {
        acceptNode(node){
          if(!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
          const p = node.parentElement;
          if(!p) return NodeFilter.FILTER_REJECT;
          if(['SCRIPT','STYLE','NOSCRIPT'].includes(p.tagName)) return NodeFilter.FILTER_REJECT;
          return NodeFilter.FILTER_ACCEPT;
        }
      }
    );

    const nodes = [];
    let n;
    while(n = walker.nextNode()) nodes.push(n);

    nodes.forEach(textNode=>{
      const text = textNode.nodeValue;
      if(!re.test(text)) return;
      re.lastIndex = 0;

      const frag = doc.createDocumentFragment();
      let last = 0, m;

      while((m = re.exec(text))){
        if(m.index > last){
          frag.appendChild(doc.createTextNode(text.slice(last, m.index)));
        }
        const mark = doc.createElement('mark');
        mark.textContent = m[0];
        frag.appendChild(mark);
        last = m.index + m[0].length;
      }

      if(last < text.length){
        frag.appendChild(doc.createTextNode(text.slice(last)));
      }

      textNode.parentNode.replaceChild(frag, textNode);
    });

    const first = doc.querySelector('mark');
    if(first){
      first.scrollIntoView({ block:'center', behavior:'smooth' });
    }
  }catch(e){}
}

btnSearch.addEventListener('click', ()=> { if(searchPanel.style.display === 'flex') closeSearchPanel(); else openSearchPanel(); });
searchClose.addEventListener('click', ()=> closeSearchPanel());
searchClear.addEventListener('click', ()=> clearSearch());
searchInput.addEventListener('keydown', (e)=> { if(e.key === 'Escape'){ closeSearchPanel(); return; } if(e.key === 'Enter'){ e.preventDefault(); performSearch(searchInput.value); }});
searchInput.addEventListener('input', ()=> { debouncePerformSearch(searchInput.value, 160); });

(function restoreSearchState(){ const q = localStorage.getItem(SEARCH_Q_KEY) || ''; lastQuery = q; try{ const raw = localStorage.getItem(SEARCH_R_KEY); if(raw) lastResults = JSON.parse(raw) || []; }catch(e){ lastResults = []; }})();

function isDesktop(){ return window.innerWidth >= DESKTOP_BREAK; }
function showCover(){ currentFlatIndex = -1; cover.style.display = 'flex'; reader.style.display = 'none'; pageShell.style.display = 'none'; mobileReader.style.display = 'none'; pageChapter.innerHTML=''; mobileChapter.innerHTML=''; detachPageSaver(); detachWindowSaver(); history.replaceState({}, '', './'); updateNavButtons(); }

async function startBackgroundUpdater(){ if(navigator.onLine) updateAllBackground().catch(()=>{}); if(bgTimer) clearInterval(bgTimer); bgTimer = setInterval(()=> { if(navigator.onLine) updateAllBackground().catch(()=>{}); }, UPDATE_INTERVAL_MS); window.addEventListener('online', ()=> updateAllBackground().catch(()=>{})); }
async function updateAllBackground(){ const ids = collectChapterIds(); if(!ids.length) return; for(const id of ids){ try{ const t = await fetchChapterRaw(id, true); if(t) cache[id] = t; }catch(e){} } try{ localStorage.setItem(UPDATE_TS_KEY, String(Date.now())); }catch(e){} }

window.addEventListener('load', async ()=>{
  startBackgroundUpdater();
  try{ if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{}); }catch(e){}
  const hadStarted = localStorage.getItem(VISITED_FLAG);
  const last = loadLastRead();
  if(!hadStarted){ showCover(); return; }
  if(last){
    if(last.kind === 'fragment'){ await openFragment(last.id); setFlatIndexFromLast(last); return; }
    if(last.kind === 'chapter'){ await openChapter(last.id, last.anchor || null); setFlatIndexFromLast(last); return; }
  }
  showCover();
});

function setFlatIndexFromLast(last){ for(let i=0;i<FLAT.length;i++){ const it = FLAT[i]; if(last.kind === 'fragment' && it.kind === 'fragment' && it.id===last.id){ currentFlatIndex = i; return; } if(last.kind === 'chapter' && it.kind === 'chapter' && it.id===last.id){ currentFlatIndex = i; return; } if(last.kind === 'chapter' && it.kind === 'anchor' && it.chapter===last.id && it.anchor===last.anchor){ currentFlatIndex = i; return; } } updateNavButtons(); }
function loadLastRead(){ try{ const raw = localStorage.getItem(LAST_READ_KEY); return raw ? JSON.parse(raw) : null; }catch(e){ return null; } }
window.addEventListener('popstate', (ev)=>{ if(!ev.state){ showCover(); return; } const s = ev.state; if(s.kind === 'fragment') openFragment(s.id); else if(s.kind === 'chapter') openChapter(s.id, s.anchor || null); });

/* close TOC when clicking outside */
document.addEventListener('click',(e)=>{ if(!tocDrawer.classList.contains('open')) return; if(e.target.closest('#tocDrawer')||e.target.closest('#btnMenu')) return; tocDrawer.classList.remove('open'); btnMenu.classList.remove('open'); });
document.addEventListener('keydown',(e)=>{ if(e.key === 'Escape'){ if(searchPanel.style.display === 'flex') closeSearchPanel(); else tocDrawer.classList.remove('open'); } if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='m'){ e.preventDefault(); btnMenu.click(); } });

window._GSR = { TOC, FLAT, openFragment, openChapter, performSearch, updateAllBackground };

let _rt = null;
window.addEventListener('resize', ()=>{
  clearTimeout(_rt);
  _rt = setTimeout(()=> {
    if(window.__gkr_search_open) return;
    if(window.__gkr_search_resize_lock) return;
    if(reader.style.display !== 'none' && lastHtml) renderHtml(lastHtml);
  }, 180);
});

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(()=>console.log('sw registered')).catch(console.error);
}

/* UX: close search panel when clicking anywhere outside it (desktop & mobile) */
(function installGlobalClickToCloseSearch(){
  document.addEventListener('click', function (e) {
    try {
      if (!searchPanel || searchPanel.style.display !== 'flex') return;
      if (e.target.closest && (e.target.closest('#searchPanel') || e.target.closest('#btnSearch'))) return;
      closeSearchPanel();
    } catch (err) {}
  }, { passive: true, capture: false });

  document.addEventListener('touchstart', function (e) {
    try {
      if (!searchPanel || searchPanel.style.display !== 'flex') return;
      if (e.target.closest && (e.target.closest('#searchPanel') || e.target.closest('#btnSearch'))) return;
      closeSearchPanel();
    } catch (err) {}
  }, { passive: true, capture: false });
})();

  function highlightInIframe(iframe, query){
  if(!query) return;

  try{
    const doc = iframe.contentDocument;
    if(!doc) return;

    const esc = query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    const re = new RegExp(esc, 'gi');

    const walker = doc.createTreeWalker(
      doc.body,
      NodeFilter.SHOW_TEXT,
      {
        acceptNode(node){
          if(!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
          const p = node.parentElement;
          if(!p) return NodeFilter.FILTER_REJECT;
          if(['SCRIPT','STYLE','NOSCRIPT'].includes(p.tagName)) return NodeFilter.FILTER_REJECT;
          return NodeFilter.FILTER_ACCEPT;
        }
      }
    );

    const nodes = [];
    let n;
    while(n = walker.nextNode()) nodes.push(n);

    nodes.forEach(textNode=>{
      const text = textNode.nodeValue;
      if(!re.test(text)) return;
      re.lastIndex = 0;

      const frag = doc.createDocumentFragment();
      let last = 0, m;
      while((m = re.exec(text))){
        if(m.index > last){
          frag.appendChild(doc.createTextNode(text.slice(last, m.index)));
        }
        const mark = doc.createElement('mark');
        mark.style.background = '#fff59d';
        mark.style.padding = '0 2px';
        mark.textContent = m[0];
        frag.appendChild(mark);
        last = m.index + m[0].length;
      }
      if(last < text.length){
        frag.appendChild(doc.createTextNode(text.slice(last)));
      }
      textNode.parentNode.replaceChild(frag, textNode);
    });

    const first = doc.querySelector('mark');
    if(first){
      first.scrollIntoView({ block:'center', behavior:'smooth' });
    }
  }catch(e){}
}

</script>
</body>
</html>
