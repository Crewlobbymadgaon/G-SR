<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>G&SR — Konkan Railway (Offline Book)</title>

  <!-- Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b63d6">

  <style>
    :root{
      --bg:#f6f9ff; --card:#ffffff;
      --kr:#0b63d6; --kr2:#0b9cff;
      --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body,html{margin:0;padding:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:var(--bg);color:#071033}

    /* Header */
    header{
      position:fixed;left:0;right:0;top:0;height:64px;
      display:flex;align-items:center;gap:12px;
      padding:10px 14px;
      background:linear-gradient(90deg,var(--kr),var(--kr2));
      color:#fff;z-index:1200;box-shadow:0 4px 18px rgba(0,0,0,0.14);
    }
    .brand{flex:1;text-align:center;font-weight:800;font-size:1.05rem}

    /* Menu button (hamburger → X animation) */
    .menu-btn{width:44px;height:44px;display:grid;place-items:center;
      border-radius:10px;cursor:pointer;background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.15);
    }
    .hamburger{width:22px;height:16px;position:relative}
    .hamburger span{
      position:absolute;left:0;right:0;height:2px;background:#fff;
      transition:.24s; border-radius:2px;
    }
    .hamburger span:nth-child(1){top:0}
    .hamburger span:nth-child(2){top:7px}
    .hamburger span:nth-child(3){top:14px}

    .menu-btn.open .hamburger span:nth-child(1){transform:translateY(7px) rotate(45deg)}
    .menu-btn.open .hamburger span:nth-child(2){opacity:0}
    .menu-btn.open .hamburger span:nth-child(3){transform:translateY(-7px) rotate(-45deg)}

    main{padding:88px 16px 120px;max-width:980px;margin:0 auto}

    /* COVER */
    .cover-image{
      width:100%;border-radius:16px;overflow:hidden;
      height:400px;position:relative;
      background:#111;box-shadow:0 12px 30px rgba(0,0,0,0.14);
      display:flex;align-items:center;justify-content:center;
    }
    .cover-image img{width:100%;height:100%;object-fit:cover}

    .cover-overlay{
      position:absolute;left:0;right:0;top:0;bottom:0;
      display:flex;align-items:center;justify-content:center;
      padding:20px;background:rgba(0,0,0,0.25);
      backdrop-filter:blur(4px);
    }
    .cover-card{
      max-width:70ch;text-align:center;color:#fff;
      padding:20px;border-radius:12px;
      background:rgba(0,0,0,0.35);
    }
    .cover-card h1{margin:0 0 10px;font-size:1.6rem}
    .cover-card p{margin:0 0 14px}

    .cta-row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .cover-open{
      background:linear-gradient(90deg,var(--kr),var(--kr2));
      border:0;color:#fff;font-weight:700;
      padding:10px 16px;border-radius:12px;cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,0.22);
    }
    .cover-prefetch{
      border:1px solid rgba(255,255,255,.4);
      padding:10px 14px;border-radius:12px;
      background:#fff;color:var(--kr);font-weight:700;cursor:pointer;
    }
    .cover-clear{
      background:transparent;border:0;color:#fff;text-decoration:underline;cursor:pointer;
    }

    /* TOC drawer */
    #tocDrawer{
      position:fixed;left:12px;top:84px;bottom:100px;
      width:300px;max-width:90vw;
      background:var(--card);border-radius:14px;
      padding:12px;box-shadow:0 18px 40px rgba(0,0,0,0.15);
      opacity:0;pointer-events:none;transform:translateY(-10px);
      transition:.25s;z-index:1300;
    }
    #tocDrawer.open{opacity:1;pointer-events:auto;transform:translateY(0)}
    .toc-list{list-style:none;padding:0;margin:0;max-height:60vh;overflow:auto}
    .toc-list a{text-decoration:none;color:#071033;font-weight:600;display:block;padding:6px}

    /* Reader */
    #reader .chapter{
      background:var(--card);padding:16px;border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,0.05);
    }

    footer{
      position:fixed;left:0;right:0;bottom:0;
      display:flex;justify-content:center;align-items:center;gap:16px;
      padding:12px;background:#fff;
      box-shadow:0 -6px 18px rgba(0,0,0,0.05);
    }
    .nav-small button{
      background:#fff;border:1px solid #ccc;
      padding:6px 10px;border-radius:8px;
      cursor:pointer;font-weight:700;
    }
  </style>
</head>

<body>
<header>
  <button id="btnMenu" class="menu-btn" aria-label="Open TOC"><span class="hamburger"><span></span><span></span><span></span></span></button>
  <div class="brand">G&SR — Konkan Railway</div>
  <div style="width:44px;height:44px;"></div>
</header>

<!-- TOC -->
<nav id="tocDrawer">
  <h3>Contents</h3>
  <ul id="tocList" class="toc-list"></ul>
</nav>

<main>

  <!-- IMAGE COVER -->
  <section id="cover" class="cover-image">
    <img
      srcset="/assets/cover-800.webp 800w, /assets/cover-1200.webp 1200w, /assets/cover-1600.webp 1600w"
      sizes="(max-width: 640px) 95vw, (max-width: 980px) 90vw, 800px"
      src="/assets/cover-1200.webp"
      alt="G&SR Konkan Railway — Book Cover" loading="eager"
    >

    <div class="cover-overlay">
      <div class="cover-card">
        <h1>General & Subsidiary Rules — Konkan Railway</h1>
        <p>Official Offline Edition — Works fully without internet</p>
        <div class="cta-row">
          <button id="openBook" class="cover-open">Open Book</button>
          <button id="prefetchBtn" class="cover-prefetch">Prefetch First</button>
          <button id="clearResume" class="cover-clear">Clear Resume</button>
        </div>
      </div>
    </div>
  </section>

  <div id="reader">
    <div class="chapter" id="placeholder">
      <h2>Welcome</h2>
      <p style="color:var(--muted)">Tap “Open Book” or choose from the menu.</p>
    </div>
  </div>

</main>

<footer>
  <div class="nav-small"><button id="prevBtn">◀</button></div>
  <div class="nav-small"><button id="nextBtn">▶</button></div>
</footer>

<script>
/* ================================
   CHAPTER LIST
================================= */
const CHAPTERS = [
  {id:'ch1', title:'Chapter 1 — Introduction'},
  {id:'ch2', title:'Chapter 2 — Definitions & Interpretations'},
  {id:'ch3', title:'Chapter 3 — Personnel & Duties'},
  {id:'ch4', title:'Chapter 4 — Signalling'},
  {id:'ch5', title:'Chapter 5 — Block Working'},
  {id:'ch6', title:'Chapter 6 — Train Operations'},
  {id:'ch7', title:'Chapter 7 — Speed Restrictions'},
  {id:'ch8', title:'Chapter 8 — Signalling Failures'},
  {id:'ch9', title:'Chapter 9 — Block Instruments & Communication'},
  {id:'ch10', title:'Chapter 10 — Shunting & Yard Working'},
  {id:'ch11', title:'Chapter 11 — Working Rules for Trains'},
  {id:'ch12', title:'Chapter 12 — Safety & Emergency Procedures'},
  {id:'ch13', title:'Chapter 13 — Working of Level Crossings'},
  {id:'ch14', title:'Chapter 14 — Tunnels & Special Sections'},
  {id:'ch15', title:'Chapter 15 — Electrical & Signalling Maintenance'},
  {id:'ch16', title:'Chapter 16 — Training & Competency'},
  {id:'ch17', title:'Chapter 17 — Record Keeping & Reporting'},
  {id:'ch18', title:'Chapter 18 — Annexures & Forms'},
  {id:'appendix', title:'Appendix — Reference Material'}
];

let currentIndex = -1;
let cache = {};

/* Resume Storage Keys */
const LAST_READ_KEY = "gkr_last_read";
const SCROLL_KEY_PREFIX = "gkr_scroll_";

/* ================================
   POPULATE TOC
================================= */
const tocList = document.getElementById('tocList');
CHAPTERS.forEach((c,i)=>{
  const li=document.createElement('li');
  const a=document.createElement('a');
  a.textContent=`${i+1}. ${c.title}`;
  a.href='#'+c.id;
  a.onclick=(e)=>{e.preventDefault(); openChapterByIndex(i); closeTOC();};
  li.appendChild(a);
  tocList.appendChild(li);
});

/* ================================
   MENU TOGGLE
================================= */
const btnMenu = document.getElementById('btnMenu');
const tocDrawer = document.getElementById('tocDrawer');
btnMenu.onclick=()=>{
  tocDrawer.classList.toggle('open');
  btnMenu.classList.toggle('open');
};
function closeTOC(){ tocDrawer.classList.remove('open'); btnMenu.classList.remove('open'); }

/* ================================
   OPEN BOOK
================================= */
document.getElementById('openBook').onclick=()=> openChapterByIndex(0);
document.getElementById('prefetchBtn').onclick=()=> prefetchChapter(0);
document.getElementById('clearResume').onclick=()=>{
  localStorage.removeItem(LAST_READ_KEY);
  CHAPTERS.forEach(c=>localStorage.removeItem(SCROLL_KEY_PREFIX+c.id));
  alert("Resume cleared");
};

/* ================================
   NAV BUTTONS
================================= */
document.getElementById('prevBtn').onclick=()=>{
  if(currentIndex>0) openChapterByIndex(currentIndex-1);
  else goCover();
};
document.getElementById('nextBtn').onclick=()=>{
  if(currentIndex<CHAPTERS.length-1) openChapterByIndex(currentIndex+1);
};

/* ================================
   OPEN A CHAPTER
================================= */
const reader = document.getElementById('reader');

async function openChapterByIndex(i){
  if(i<0||i>=CHAPTERS.length) return;
  currentIndex=i;
  const id = CHAPTERS[i].id;
  await loadChapter(id);
  saveLastRead(i,id);
  history.pushState({id,index:i},"","#"+id);
}

async function loadChapter(id){
  if(cache[id]) return renderChapter(cache[id],id);

  const res = await fetch(`/chapters/${id}.html`,{cache:"force-cache"});
  if(!res.ok){ reader.innerHTML="<p>Error loading chapter</p>"; return; }
  const html = await res.text();
  cache[id]=html;
  renderChapter(html,id);
}

function renderChapter(html,id){
  reader.innerHTML=`<div class="chapter">${html}</div>`;
  restoreScroll(id);
  attachScrollSaver(id);
}

/* ================================
   COVER PAGE
================================= */
function goCover(){
  currentIndex=-1;
  reader.innerHTML=document.getElementById('placeholder').outerHTML;
}

/* ================================
   RESUME FUNCTIONS
================================= */
function saveLastRead(index,id){
  localStorage.setItem(LAST_READ_KEY,JSON.stringify({index,id,ts:Date.now()}));
}
function loadLastRead(){
  const raw=localStorage.getItem(LAST_READ_KEY);
  return raw?JSON.parse(raw):null;
}

function saveScroll(id,scroll){
  localStorage.setItem(SCROLL_KEY_PREFIX+id,scroll);
}
function restoreScroll(id){
  const saved = Number(localStorage.getItem(SCROLL_KEY_PREFIX+id)||0);
  if(saved>0){ setTimeout(()=>{ window.scrollTo(0,saved); },60); }
}

/* Save scroll continuously */
let scrollTimer=null;
function attachScrollSaver(id){
  window.onscroll=()=>{
    clearTimeout(scrollTimer);
    scrollTimer=setTimeout(()=>{
      saveScroll(id,window.scrollY);
    },400);
  };
}

/* ================================
   PREFETCH
================================= */
async function prefetchChapter(i){
  const id=CHAPTERS[i].id;
  fetch(`/chapters/${id}.html`,{cache:"force-cache"});
  alert("Chapter prefetched");
}

/* ================================
   RESTORE ON LOAD
================================= */
window.onload=()=>{
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("/sw.js");
  }
  const last = loadLastRead();
  if(last && last.id){
    const idx = CHAPTERS.findIndex(c=>c.id===last.id);
    if(idx>=0) openChapterByIndex(idx);
  }
};

/* Back button handling */
window.onpopstate=(e)=>{
  if(!e.state){ goCover(); return; }
  const {id,index}=e.state;
  if(index>=0) openChapterByIndex(index);
};
</script>

</body>
</html>
