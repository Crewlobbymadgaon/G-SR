<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>G&SR — Konkan Railway (Offline Book)</title>

  <!-- manifest (relative) -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b63d6">

  <style>
    :root{--bg:#f6f9ff;--card:#fff;--kr:#0b63d6;--kr2:#0b9cff;--muted:#6b7280}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:var(--bg);color:#071033}
    header{position:fixed;left:0;right:0;top:0;height:64px;display:flex;align-items:center;gap:12px;padding:10px 14px;background:linear-gradient(90deg,var(--kr),var(--kr2));color:#fff;z-index:1200}
    .brand{flex:1;text-align:center;font-weight:800}
    .menu-btn{width:44px;height:44px;display:grid;place-items:center;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);cursor:pointer}
    .hamburger{width:22px;height:16px;position:relative}
    .hamburger span{position:absolute;left:0;right:0;height:2px;background:#fff;border-radius:2px;transition:.24s}
    .hamburger span:nth-child(1){top:0}
    .hamburger span:nth-child(2){top:7px}
    .hamburger span:nth-child(3){top:14px}
    .menu-btn.open .hamburger span:nth-child(1){transform:translateY(7px) rotate(45deg)}
    .menu-btn.open .hamburger span:nth-child(2){opacity:0}
    .menu-btn.open .hamburger span:nth-child(3){transform:translateY(-7px) rotate(-45deg)}

    main{padding:88px 16px 120px;max-width:980px;margin:0 auto;min-height:320px}
    /* Cover centered image; hidden when a chapter is open */
    #cover { width:100%; border-radius:16px; overflow:hidden; height:420px; position:relative; background:#111; box-shadow:0 12px 30px rgba(0,0,0,.14); display:flex; align-items:center; justify-content:center; }
    #cover img{ width:100%; height:100%; object-fit:cover; display:block; }

    /* Reader area (hidden when cover visible) */
    #reader { margin-top:18px; display:none; }

    .chapter { background:var(--card); padding:18px; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.05); min-height:200px; }

    /* TOC drawer (title changed below in HTML) */
    #tocDrawer{position:fixed;left:12px;top:84px;bottom:100px;width:340px;max-width:92vw;background:var(--card);border-radius:14px;padding:12px;box-shadow:0 18px 40px rgba(0,0,0,.12);opacity:0;pointer-events:none;transform:translateY(-10px);transition:.24s;z-index:1300}
    #tocDrawer.open{opacity:1;pointer-events:auto;transform:none}
    .toc-title{font-weight:800;margin:4px 0 12px;font-size:1.05rem;color:#05204a}
    .toc-list{list-style:none;padding:0;margin:0;max-height:60vh;overflow:auto}
    .toc-list a{text-decoration:none;color:#05204a;display:block;padding:8px;border-radius:8px;font-weight:600}
    .toc-list a:hover{background:rgba(11,99,214,0.04)}

    footer{position:fixed;left:0;right:0;bottom:0;padding:12px;background:#fff;display:flex;justify-content:center;gap:12px;box-shadow:0 -6px 18px rgba(0,0,0,.05)}
    .nav-small button{background:#fff;border:1px solid #ccc;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}

    /* small helpers for the sample chapter content */
    .chapter h2{margin-top:0}
    .rule-list{margin-left:1.1rem;color:#0b63d6;font-weight:600}
    .rule-list li{margin:10px 0;font-size:1.05rem}

    @media(max-width:640px){
      #cover{height:520px}
      main{padding:84px 12px 140px}
      #tocDrawer{width:86vw}
    }
  </style>
</head>
<body>
  <header>
    <button id="btnMenu" class="menu-btn" aria-label="Open TOC"><span class="hamburger"><span></span><span></span><span></span></span></button>
    <div class="brand">G&SR — Konkan Railway</div>
    <div style="width:44px;height:44px;"></div>
  </header>

  <!-- TOC with requested title -->
  <nav id="tocDrawer" aria-hidden="true" aria-label="Arrangement of Rules">
    <div class="toc-title">ARRANGEMENT OF RULES</div>
    <ul id="tocList" class="toc-list" role="list"></ul>
  </nav>

  <main>
    <!-- Cover: only the image -->
    <section id="cover" aria-hidden="false" role="img" aria-label="Book cover image">
      <img
        srcset="assets/cover-800.webp 800w, assets/cover-1200.webp 1200w, assets/cover-1600.webp 1600w"
        sizes="(max-width:640px) 95vw, (max-width:980px) 90vw, 800px"
        src="assets/cover-1200.webp"
        alt="G&SR Konkan Railway — Book cover"
        decoding="async"
        loading="eager"
      />
    </section>

    <!-- Reader: initially hidden; will replace cover when a chapter opens -->
    <section id="reader" aria-live="polite" tabindex="-1">
      <!-- injected content appears here -->
    </section>
  </main>

  <footer>
    <div class="nav-small"><button id="prevBtn" aria-label="Previous">◀</button></div>
    <div class="nav-small"><button id="nextBtn" aria-label="Next">▶</button></div>
  </footer>

<script>
/* ---------- Configuration + core ---------- */
/*
 Items at top of the menu to match your image:
  - Notification (id: notif)
  - Resolution (id: res)
  - Documents Accompanying (id: docs)
 Then Chapter I (ch1) with PRELIMINARY entries (1.01, 1.02, 1.03)
*/
const CHAPTERS = [
  { id: 'notif', title: 'Notification' },
  { id: 'res', title: 'Resolution' },
  { id: 'docs', title: 'Documents Accompanying' },
  { id: 'ch1', title: 'CHAPTER I — PRELIMINARY' },
  // rest of book
  { id: 'ch2', title: 'Chapter 2 — Definitions & Interpretations' },
  { id: 'ch3', title: 'Chapter 3 — Personnel & Duties' },
  { id: 'ch4', title: 'Chapter 4 — Signalling' },
  { id: 'ch5', title: 'Chapter 5 — Block Working' },
  { id: 'ch6', title: 'Chapter 6 — Train Operations' },
  { id: 'ch7', title: 'Chapter 7 — Speed Restrictions' },
  { id: 'ch8', title: 'Chapter 8 — Signalling Failures' },
  { id: 'ch9', title: 'Chapter 9 — Block Instruments & Communication' },
  { id: 'ch10', title: 'Chapter 10 — Shunting & Yard Working' },
  { id: 'ch11', title: 'Chapter 11 — Working Rules for Trains' },
  { id: 'ch12', title: 'Chapter 12 — Safety & Emergency Procedures' },
  { id: 'ch13', title: 'Chapter 13 — Working of Level Crossings' },
  { id: 'ch14', title: 'Chapter 14 — Tunnels & Special Sections' },
  { id: 'ch15', title: 'Chapter 15 — Electrical & Signalling Maintenance' },
  { id: 'ch16', title: 'Chapter 16 — Training & Competency' },
  { id: 'ch17', title: 'Chapter 17 — Record Keeping & Reporting' },
  { id: 'ch18', title: 'Chapter 18 — Annexures & Forms' },
  { id: 'appendix', title: 'Appendix — Reference Material' }
];

const VISITED_FLAG = 'gkr_had_started_reading';
const LAST_READ_KEY = 'gkr_last_read';
const SCROLL_PREFIX = 'gkr_scroll_';

let currentIndex = -1;
let cache = {}; // dynamic cache for fetched or preloaded fragments
let scrollSaver = { timer: null, lastSaved: 0, id: null, onScroll: null };

/* ---------- Preload sample fragments for quick testing ----------
   These avoid needing separate files for the first items.
   You may replace or remove these and create /chapters/*.html files later.
*/
cache['notif'] = `
  <article class="chapter-content" data-title="Notification">
    <h2>Notification</h2>
    <p>This section contains notifications relevant to the General &amp; Subsidiary Rules for Konkan Railway.</p>
    <p style="color:var(--muted)">(Sample content — replace with official notification text.)</p>
  </article>
`;

cache['res'] = `
  <article class="chapter-content" data-title="Resolution">
    <h2>Resolution</h2>
    <p>Resolutions and official orders affecting the application of the rules.</p>
    <p style="color:var(--muted)">(Sample content — replace with real resolutions.)</p>
  </article>
`;

cache['docs'] = `
  <article class="chapter-content" data-title="Documents Accompanying">
    <h2>Documents Accompanying</h2>
    <p>List of documents, forms and annexures that accompany these rules.</p>
    <ul>
      <li>Form A — Register</li>
      <li>Form B — Report</li>
      <li>Annexure I — Contact List</li>
    </ul>
    <p style="color:var(--muted)">(Sample list — edit as required.)</p>
  </article>
`;

/* CHAPTER 1 sample matching the image layout (ARRANGEMENT OF RULES -> CHAPTER I -> PRELIMINARY) */
cache['ch1'] = `
  <article class="chapter-content" data-title="Chapter 1 — Preliminary">
    <h2>CHAPTER I</h2>
    <h3>PRELIMINARY</h3>

    <p style="margin-top:12px">Arrangement of rules for quick reference:</p>
    <ul class="rule-list">
      <li>1.01 Short title and commencement</li>
      <li>1.02 Definitions</li>
      <li>1.03 Classification of Stations</li>
    </ul>

    <h4 style="margin-top:18px">1.01 Short title and commencement</h4>
    <p>This rule states the short title of the book and the date on which it comes into force.</p>

    <h4 style="margin-top:12px">1.02 Definitions</h4>
    <p>Definitions of terms used in this volume. Example terms include "Train", "Block section", "Loco pilot".</p>

    <h4 style="margin-top:12px">1.03 Classification of Stations</h4>
    <p>Stations are classified for working and operational purposes. The classification depends on traffic handled and signaling arrangements.</p>

    <hr style="margin-top:18px">
    <p style="font-size:.95rem;color:var(--muted)">End of sample CHAPTER I. Replace this with the official G&SR text.</p>
  </article>
`;

/* ---------- DOM refs ---------- */
const tocList = document.getElementById('tocList');
const btnMenu = document.getElementById('btnMenu');
const tocDrawer = document.getElementById('tocDrawer');
const coverEl = document.getElementById('cover');
const reader = document.getElementById('reader');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

/* ---------- Populate TOC (uses CHAPTERS array) ---------- */
(function populateTOC(){
  CHAPTERS.forEach((c,i)=>{
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = '#' + c.id;
    a.textContent = `${i+1}. ${c.title}`;
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      markStartedAndOpen(i);
      closeTOC();
    });
    li.appendChild(a);
    tocList.appendChild(li);
  });
})();

/* ---------- TOC toggle ---------- */
btnMenu.addEventListener('click', ()=>{
  const open = tocDrawer.classList.toggle('open');
  btnMenu.classList.toggle('open', open);
  btnMenu.setAttribute('aria-expanded', String(open));
  tocDrawer.setAttribute('aria-hidden', String(!open));
  if(open) setTimeout(()=>{ const first = tocDrawer.querySelector('a'); if(first) first.focus(); }, 80);
});
function closeTOC(){ tocDrawer.classList.remove('open'); btnMenu.classList.remove('open'); btnMenu.setAttribute('aria-expanded','false'); tocDrawer.setAttribute('aria-hidden','true'); }

/* ---------- Footer navigation ---------- */
prevBtn.addEventListener('click', ()=>{
  if(currentIndex > 0) openChapterByIndex(currentIndex - 1);
  else if(currentIndex === 0) showCover();
});
nextBtn.addEventListener('click', ()=>{
  if(currentIndex === -1){
    // from cover: forward arrow opens Chapter 1 (and mark started)
    markStartedAndOpen(3); // index 3 is ch1 in CHAPTERS array above
  } else if(currentIndex < CHAPTERS.length - 1){
    openChapterByIndex(currentIndex + 1);
  }
});

/* ---------- Helpers ---------- */
function markStartedAndOpen(index){
  localStorage.setItem(VISITED_FLAG, '1');
  openChapterByIndex(index);
}

/* ---------- Chapter load and rendering ----------
   If a fragment is preloaded in cache[] it will be used.
   Otherwise the code will attempt to fetch `chapters/{id}.html`.
*/
async function openChapterByIndex(i){
  if(i < 0 || i >= CHAPTERS.length) return;
  currentIndex = i;
  const id = CHAPTERS[i].id;
  // mark started
  localStorage.setItem(VISITED_FLAG, '1');
  await loadChapter(id);
  saveLastRead(i, id);
  history.pushState({id, index: i}, '', '#' + id);
}

async function loadChapter(id){
  if(cache[id]) { renderChapter(cache[id], id); return; }
  try {
    showLoader();
    // attempt to fetch chapters/{id}.html as fallback
    const res = await fetch(`chapters/${id}.html`, { cache: 'force-cache' });
    if(!res.ok) throw new Error('Fetch failed ' + res.status);
    const text = await res.text();
    cache[id] = text;
    renderChapter(text, id);
  } catch (e) {
    console.warn('loadChapter error', e);
    const fallback = `<div class="chapter"><h2>Missing chapter</h2><p style="color:var(--muted)">This chapter fragment is not available. Create <code>chapters/${id}.html</code> or replace the sample content in the index.</p></div>`;
    renderChapter(fallback, id);
  } finally { hideLoader(); }
}

function renderChapter(html, id){
  // hide cover and show reader: chapter replaces the cover visually
  coverEl.style.display = 'none';
  reader.style.display = 'block';
  reader.innerHTML = `<div class="chapter">${html}</div>`;
  restoreScroll(id);
  attachScrollSaver(id);
  const el = reader.querySelector('.chapter');
  if(el){ el.setAttribute('tabindex','-1'); el.focus(); }
}

function showCover(){
  currentIndex = -1;
  coverEl.style.display = 'flex';
  reader.style.display = 'none';
  reader.innerHTML = '';
  detachScrollSaver();
  history.replaceState({}, '', './');
}

/* ---------- Loader helpers ---------- */
function showLoader(){
  if(reader && !document.getElementById('loader')){
    const d = document.createElement('div');
    d.id = 'loader'; d.style.marginTop='12px'; d.style.color='var(--muted)'; d.textContent='Loading...';
    reader.appendChild(d);
  }
}
function hideLoader(){ const l = document.getElementById('loader'); if(l) l.remove(); }

/* ---------- Resume using localStorage ---------- */
function saveLastRead(index, id){
  try { localStorage.setItem(LAST_READ_KEY, JSON.stringify({ index:Number(index), id:String(id), ts: Date.now() })); } catch(e){ console.warn('saveLastRead', e); }
}
function loadLastRead(){ try { const raw = localStorage.getItem(LAST_READ_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; } }

function saveChapterScroll(chId, pos){ try { localStorage.setItem(SCROLL_PREFIX + chId, String(Math.floor(pos))); } catch(e){} }
function loadChapterScroll(chId){ try { const raw = localStorage.getItem(SCROLL_PREFIX + chId); return raw ? Number(raw) || 0 : 0; } catch(e){ return 0; } }

function restoreScroll(id){
  const s = loadChapterScroll(id) || 0;
  if(s > 0) setTimeout(()=> window.scrollTo({ top: s, behavior: 'auto' }), 60);
  else setTimeout(()=> window.scrollTo({ top: 0, behavior: 'auto' }), 60);
}

/* ---------- Scroll saver (throttled) ---------- */
function attachScrollSaver(chapterId){
  detachScrollSaver();
  scrollSaver.id = chapterId;
  const saveNow = (pos)=> { saveChapterScroll(chapterId, pos); scrollSaver.lastSaved = Date.now(); };
  const onScroll = ()=> {
    const now = Date.now();
    if(now - scrollSaver.lastSaved > 800) saveNow(window.scrollY || 0);
    clearTimeout(scrollSaver.timer);
    scrollSaver.timer = setTimeout(()=> saveNow(window.scrollY || 0), 700);
  };
  window.addEventListener('scroll', onScroll, { passive: true });
  scrollSaver.onScroll = onScroll;
}
function detachScrollSaver(){
  if(scrollSaver.onScroll) window.removeEventListener('scroll', scrollSaver.onScroll);
  if(scrollSaver.timer) { clearTimeout(scrollSaver.timer); scrollSaver.timer = null; }
  scrollSaver.onScroll = null; scrollSaver.id = null; scrollSaver.lastSaved = 0;
}

/* ---------- Prefetch silent ---------- */
async function prefetchChapter(i){
  if(i < 0 || i >= CHAPTERS.length) return;
  const id = CHAPTERS[i].id;
  await fetch(`chapters/${id}.html`, { cache: 'force-cache' });
}

/* ---------- Restore-on-load behavior ---------- */
window.addEventListener('load', () => {
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').catch(()=>console.warn('SW registration failed'));
  }

  try {
    const hadStarted = localStorage.getItem(VISITED_FLAG);
    const last = loadLastRead();

    if(!hadStarted){
      // show cover until user opens a chapter
      showCover();
      return;
    }

    // if user had started reading earlier, restore last-read
    if(last && last.id){
      const idx = (typeof last.index === 'number' && last.index >= 0) ? last.index : CHAPTERS.findIndex(c=>c.id === last.id);
      if(idx !== -1){
        openChapterByIndex(idx).then(()=> {
          history.replaceState({id:CHAPTERS[idx].id, index: idx}, '', '#' + CHAPTERS[idx].id);
        }).catch(()=> showCover());
        return;
      }
    }

    showCover();
  } catch(e){
    console.warn('restore error', e);
    showCover();
  }
});

/* ---------- History/back handling ---------- */
window.addEventListener('popstate', (ev) => {
  if(!ev.state){ showCover(); return; }
  const { id, index } = ev.state;
  if(typeof index === 'number' && index >= 0) openChapterByIndex(index);
  else if(id){
    const idx = CHAPTERS.findIndex(c=>c.id === id);
    if(idx >= 0) openChapterByIndex(idx);
  }
});

/* ---------- Misc UX ---------- */
document.addEventListener('click', (e)=> {
  if(!tocDrawer.classList.contains('open')) return;
  if(e.target.closest('#tocDrawer') || e.target.closest('#btnMenu')) return;
  closeTOC();
});
document.addEventListener('keydown', (e)=> {
  if(e.key === 'Escape') closeTOC();
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='m'){ e.preventDefault(); btnMenu.click(); }
});

function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>
</body>
</html>
